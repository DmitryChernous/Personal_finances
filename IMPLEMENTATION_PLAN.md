# План реализации Personal_finances

Дата: 2026-01-24  
Цель: удобный и функциональный инструмент учета и анализа личных финансов на базе Google Sheets + Google Apps Script, с возможностью переиспользования (шаблон) и дальнейшим расширением (импорт выписок разных банков).

## Принципы и ограничения

- **Источник истины — таблица**: данные и расчёты максимально прозрачны (формулы/таблицы), Apps Script — для автоматизации, валидаций, меню, импорта и генерации шаблона.
- **Инкрементальная реализация**: каждый этап даёт законченный, используемый результат.
- **Расширяемость импорта**: импорт проектируется как набор “адаптеров” под банки/форматы, но реализация может быть отложена.
- **Переиспользуемость**: никаких персональных ID/ключей в git; шаблон создаётся копированием и очисткой данных.
- **Локаль таблицы (RU)**: таблица русскоязычная; синтаксис формул/форматы должны быть совместимы с `ru_RU` (см. `SHEETS_LOCALE.md`).
- **Язык интерфейса (i18n)**: имена листов/заголовки/подписи меню должны браться из словаря и зависеть от настройки `Language` (см. `src/I18n.js`, `src/Settings.js`).

## Целевая структура Google Sheets (листов)

Минимально (уже есть/частично):
- `Transactions` — транзакции
- `Categories` — справочник категорий
- `Accounts` — счета/кошельки/карты

Планируемые дополнительные листы:
- `Settings` — настройки (валюта по умолчанию, часовой пояс, правила, версии схемы)
- `Import_Raw` — “черновик” для импорта (как staging-область)
- `Import_Map` — правила сопоставления/нормализации (опционально)
- `Reports` — агрегаты (таблицы для дашборда)
- `Dashboard` — визуализация
- `Help` — инструкция по использованию

## Модель данных (черновая)

### Transactions (таблица)
Рекомендуемые колонки (порядок уточним на этапе 1):
- `Date` (дата операции)
- `Type` (`expense`/`income`/`transfer`)
- `Account` (счёт-источник/основной)
- `AccountTo` (для transfer)
- `Amount` (число, знак по договорённости)
- `Currency`
- `Category`
- `Subcategory` (опционально)
- `Merchant` (контрагент/магазин)
- `Description` (назначение/описание)
- `Tags` (опционально)
- `Source` (`manual`/`import:<bank>`/`import:csv`…)
- `SourceId` (id строки/операции из выписки, для дедупликации)
- `Status` (`ok`/`needs_review`/`duplicate`/`deleted`)
- `CreatedAt`, `UpdatedAt` (опционально, если будем вести аудит)

### Categories / Accounts
- `Categories`: список категорий (+ подкатегории) + тип (доход/расход/оба)
- `Accounts`: название, тип (карта/наличные/вклад), валюта, начальный баланс, активен/архив

## Архитектура Apps Script (модули в `src/`)

Текущее: `Code.js` (меню + `pfSetup()`), `Sheets.js` (утилиты).

Планируемые файлы:
- `Setup.js` — создание листов, шапок, форматов, валидаций, именованных диапазонов
- `Schema.js` — описание схемы (колонки, версии, миграции)
- `Validation.js` — проверка строк, подсветка ошибок, нормализация
- `Transactions.js` — операции: добавить/обновить/пометить, поиск дублей
- `Reports.js` — генерация таблиц отчётов (если решим часть агрегатов делать скриптом)
- `Ui.js` — меню, диалоги/сайдбар для ручного ввода (опционально)
- `Import/*.js` или `Importers.js` — каркас импорта (адаптеры под банки)
- `Template.js` — создание копии “шаблон” без данных

## Этапы реализации (инкременты)

Ниже — этапы с результатом, задачами и критериями готовности. Делать можно по одному этапу за раз.

### Этап 0 — Базовая подготовка (уже сделано)
**Результат**: репозиторий + clasp + минимальный setup.

- [x] `src/` + манифест `appsscript.json`
- [x] Меню и минимальный `pfSetup()` (создаёт базовые листы)
- [x] Документация по clasp в `README.md`
- [x] Базовая система настроек + i18n (RU/EN): выбор языка, переименование листов, заголовки

**DoD**: код синхронизируется через `npm run push`, меню появляется в таблице.

### Этап 1 — Схема данных и полноценный Setup
**Результат**: таблица готова к работе “из коробки”: корректные листы, шапки, форматы, валидации, базовые справочники.

- [x] Утвердить колонки `Transactions` (финальный список + форматы) — см. `TRANSACTIONS_SCHEMA.md`
- [x] Реализовать `pfSetup()` как идемпотентную инициализацию:
  - [x] Создание листов `Settings`, `Help`, `Dashboard`, `Reports` (минимально)
  - [x] Шапки таблиц, frozen row, автофильтр
  - [x] Data validation: `Type`, `Account`, `Category`, `Currency`
  - [x] Именованные диапазоны для справочников (`PF_ACCOUNTS`, `PF_CATEGORIES`)
- [x] Версионирование схемы в `Settings` (`SchemaVersion`)

**DoD**:
- новый пользователь запускает “Setup” и получает готовую структуру без ручных действий
- повторный запуск “Setup” не ломает данные и не дублирует шапки

### Этап 2 — Ручной ввод и редактирование транзакций (UX)
**Результат**: удобно добавлять/править транзакции вручную, исправлять импортированные строки.

Варианты реализации (выберем один):
- **A (быстро)**: работа прямо в `Transactions` + строгие валидации + подсказки
- **B (удобнее)**: сайдбар “Добавить транзакцию” (HTML Service) + запись в таблицу

Задачи:
- [ ] Валидации обязательных полей (дата/тип/счёт/сумма)
- [ ] Нормализация (например, трим строк, приведение валюты/типа)
- [ ] Инструмент “пометить на проверку” (`needs_review`) и подсветка
- [ ] (Опционально) обработчик onEdit для мягких подсказок/автозаполнений

**DoD**:
- можно без выписок вести учёт (добавлять/редактировать строки) ✅
- ошибки ввода выявляются и понятны пользователю ✅

### Этап 3 — Базовая аналитика (без импорта)
**Результат**: пользователь видит ключевые метрики по данным в `Transactions`.

Метрики (минимальный набор):
- [ ] Доходы/расходы за период (месяц/год)
- [ ] Расходы по категориям (топ)
- [ ] Динамика cashflow по месяцам
- [ ] Остатки по счетам (если ведём балансы через транзакции)

Реализация:
- [ ] Таблицы-агрегаты на листе `Reports` (QUERY/PIVOT/формулы) или генерация скриптом
- [ ] Параметры отчётов (период, счёт, валюта) — через `Settings`/фильтры

**DoD**:
- при добавлении транзакций отчёты обновляются (формулами или кнопкой “Refresh reports”)

### Этап 4 — Dashboard (визуализация)
**Результат**: дашборд на одном листе с основными графиками и KPI.

- [x] KPI: доход/расход/баланс за месяц, средние траты — реализовано в `pfInitializeDashboard_()`
- [x] Графики: расходы по категориям (pie chart) — реализовано через Charts API
- [ ] Графики: динамика по месяцам (line) — placeholder (можно использовать Reports)
- [ ] UX: переключатель периода — отложено (пока используется текущий месяц)
- [x] Компактный и понятный вид — KPI карточки и графики на одном листе

**DoD**:
- дашборд читается "с первого взгляда", не требует ручной настройки графиков ✅

### Этап 5 — Подготовка архитектуры импорта (без реализации парсеров)
**Результат**: есть каркас, в который легко добавить импорт конкретного банка/формата позже.

- [ ] Определить единый “внутренний формат” транзакции (DTO)
- [ ] Каркас импортера:
  - [ ] интерфейс/контракт: `detect()`, `parse()`, `normalize()`, `dedupeKey()`
  - [ ] staging в `Import_Raw`
  - [ ] шаг “Preview” (что будет добавлено) и “Commit”
- [ ] Дедупликация по `SourceId`/хэшу полей

**DoD**:
- можно добавить новый импортёр без переписывания ядра (только новый модуль/адаптер)

### Этап 6 — Реализация 1–2 импортёров (когда будешь готов)
**Результат**: загрузка выписки (например CSV) и автоматическое добавление в `Transactions`.

- [ ] Импорт CSV (универсальный)
- [ ] Импорт 1 банка (самый актуальный для тебя)
- [ ] Маппинг колонок + правила категорий (опционально)

**DoD**:
- пользователь может загрузить выписку, увидеть превью, применить, получить транзакции без дублей

### Этап 7 — Переиспользуемость (шаблон для других пользователей)
**Результат**: быстро создать “чистый” шаблон без операций.

- [ ] Команда меню: “Создать копию-шаблон”
- [ ] Копирование файла таблицы + очистка `Transactions` (оставить шапку)
- [ ] Очистка/подготовка справочников (опционально оставить демо-категории)
- [ ] Обновление `Settings` (новый владелец, версия)

**DoD**:
- новый пользователь получает рабочую таблицу за 1–2 клика

### Этап 8 — Инструкция в самой таблице (Help)
**Результат**: лист `Help` объясняет как пользоваться инструментом.

- [ ] Quick start: “Setup → добавь категории/счета → добавляй транзакции → смотри Dashboard”
- [ ] Правила: как трактуется `Amount`, что такое transfer, как работает дедуп
- [ ] FAQ и troubleshooting (права, обновление, импорт)

**DoD**:
- пользователь может начать пользоваться без чтения репозитория

## Бэклог (идеи на потом)

- Бюджеты по категориям + контроль выполнения
- Планирование (регулярные платежи)
- Мультивалютность (курсы + пересчёт)
- Распознавание категорий по мерчанту (правила)
- Экспорт/архив, восстановление из бэкапа


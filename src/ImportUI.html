<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 10px;
      margin: 0;
    }
    h2 {
      margin-top: 0;
      font-size: 16px;
    }
    .section {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input[type="file"] {
      width: 100%;
      margin-bottom: 10px;
    }
    select, input[type="text"] {
      width: 100%;
      padding: 5px;
      margin-bottom: 10px;
      box-sizing: border-box;
    }
    button {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      background-color: #4285f4;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      background-color: #357ae8;
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    .stats {
      background-color: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    .stats-item {
      margin: 5px 0;
    }
    .error {
      color: #d32f2f;
      font-size: 12px;
      margin-top: 5px;
    }
    .success {
      color: #388e3c;
      font-size: 12px;
      margin-top: 5px;
    }
    .info {
      background-color: #e3f2fd;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 10px;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <h2>Импорт транзакций</h2>
  
  <div class="info">
    Поддерживаемые форматы: CSV, Excel (через экспорт в CSV), PDF (выписки банков).<br>
    PDF: поддерживаются выписки Сбербанка и Тинькофф (автоматическое распознавание).
  </div>
  
  <div class="section">
    <label for="fileInput">Выберите файл:</label>
    <input type="file" id="fileInput" accept=".csv,.txt,.pdf" style="width: 100%; margin-bottom: 5px;">
    <div id="fileInfo" style="font-size: 12px; color: #666; margin-top: 5px;"></div>
  </div>
  
  <div class="section">
    <label for="defaultAccount">Счет по умолчанию:</label>
    <select id="defaultAccount">
      <option value="">-- Выберите счет --</option>
    </select>
  </div>
  
  <div class="section">
    <label for="defaultCurrency">Валюта по умолчанию:</label>
    <select id="defaultCurrency">
      <option value="RUB">RUB</option>
      <option value="USD">USD</option>
      <option value="EUR">EUR</option>
    </select>
  </div>
  
  <div class="section">
    <button id="previewBtn" onclick="handlePreview()">Предпросмотр</button>
    <button id="commitBtn" onclick="handleCommit()" disabled>Импортировать</button>
    <button id="commitWithReviewBtn" onclick="handleCommitWithReview()" disabled>Импортировать (включая на проверку)</button>
  </div>
  
  <div id="stats" class="stats" style="display: none;">
    <div class="stats-item"><strong>Статистика:</strong></div>
    <div class="stats-item">Всего: <span id="statTotal">0</span></div>
    <div class="stats-item">Валидных: <span id="statValid">0</span></div>
    <div class="stats-item">На проверку: <span id="statReview">0</span></div>
    <div class="stats-item">Дубликатов: <span id="statDuplicates">0</span></div>
  </div>
  
  <div id="message"></div>
  
  <div id="progress" style="display: none; margin-top: 10px;">
    <div style="background-color: #f0f0f0; border-radius: 4px; padding: 10px;">
      <div style="font-weight: bold; margin-bottom: 5px;">Обработка файла...</div>
      <div id="progressText" style="font-size: 12px; color: #666;">Инициализация...</div>
      <div style="background-color: #e0e0e0; border-radius: 2px; height: 20px; margin-top: 5px; overflow: hidden;">
        <div id="progressBar" style="background-color: #4285f4; height: 100%; width: 0%; transition: width 0.3s;"></div>
      </div>
    </div>
  </div>
  
  <script>
    var fileContent = null;
    var fileName = null;
    var previewData = null;
    
    // Load accounts on page load
    window.onload = function() {
      loadAccounts();
      
      // Handle file input
      document.getElementById('fileInput').addEventListener('change', function(e) {
        var file = e.target.files[0];
        if (file) {
          document.getElementById('message').innerHTML = '<div>Загрузка файла...</div>';
          document.getElementById('previewBtn').disabled = true;
          
          // Check if file is PDF
          var isPdf = file.name.toLowerCase().endsWith('.pdf') || file.type === 'application/pdf';
          
          var reader = new FileReader();
          reader.onload = function(e) {
            try {
              if (isPdf) {
                // For PDF, read as base64
                var base64 = e.target.result.split(',')[1]; // Remove data:application/pdf;base64, prefix
                fileContent = base64;
                fileName = file.name;
                if (fileContent && fileContent.length > 0) {
                  var sizeMB = (file.size / 1024 / 1024).toFixed(2);
                  document.getElementById('fileInfo').textContent = 'Файл: ' + file.name + ' (' + sizeMB + ' MB, PDF)';
                  document.getElementById('message').innerHTML = 
                    '<div class="success">PDF файл загружен: ' + file.name + ' (' + sizeMB + ' MB)</div>';
                } else {
                  showError('PDF файл пуст или не удалось прочитать содержимое');
                  document.getElementById('fileInfo').textContent = '';
                  document.getElementById('previewBtn').disabled = true;
                  fileContent = null;
                  fileName = null;
                  return;
                }
              } else {
                // For text files (CSV), read as text
                fileContent = e.target.result;
                fileName = file.name;
                if (fileContent && fileContent.length > 0) {
                  document.getElementById('fileInfo').textContent = 'Файл: ' + file.name + ' (' + fileContent.length + ' символов)';
                  document.getElementById('message').innerHTML = 
                    '<div class="success">Файл загружен: ' + file.name + ' (' + fileContent.length + ' символов)</div>';
                } else {
                  showError('Файл пуст или не удалось прочитать содержимое');
                  document.getElementById('fileInfo').textContent = '';
                  document.getElementById('previewBtn').disabled = true;
                  fileContent = null;
                  fileName = null;
                  return;
                }
              }
              
              // Reset preview
              previewData = null;
              document.getElementById('previewBtn').disabled = false;
              document.getElementById('commitBtn').disabled = true;
              document.getElementById('commitWithReviewBtn').disabled = true;
              document.getElementById('stats').style.display = 'none';
            } catch (err) {
              showError('Ошибка при чтении файла: ' + err.message);
              document.getElementById('fileInfo').textContent = '';
              document.getElementById('previewBtn').disabled = true;
              fileContent = null;
              fileName = null;
            }
          };
          reader.onerror = function(e) {
            showError('Ошибка при чтении файла. Код ошибки: ' + (e.target.error ? e.target.error.code : 'unknown'));
            document.getElementById('fileInfo').textContent = '';
            document.getElementById('previewBtn').disabled = true;
            fileContent = null;
            fileName = null;
          };
          
          if (isPdf) {
            reader.readAsDataURL(file); // Read as base64 for PDF
          } else {
            reader.readAsText(file, 'UTF-8'); // Read as text for CSV
          }
        } else {
          fileContent = null;
          document.getElementById('fileInfo').textContent = '';
          document.getElementById('previewBtn').disabled = true;
          document.getElementById('message').innerHTML = '';
        }
      });
    };
    
    function loadAccounts() {
      console.log('[CLIENT] Loading accounts...');
      google.script.run
        .withSuccessHandler(function(accounts) {
          console.log('[CLIENT] Accounts loaded:', accounts);
          var select = document.getElementById('defaultAccount');
          
          // Clear existing options (except first one)
          while (select.options.length > 1) {
            select.remove(1);
          }
          
          if (!accounts || accounts.length === 0) {
            console.warn('[CLIENT] No accounts found!');
            // Add a message option
            var option = document.createElement('option');
            option.value = '';
            option.text = '-- Сначала создайте счет в листе "Счета" --';
            option.disabled = true;
            select.appendChild(option);
          } else {
            accounts.forEach(function(account) {
              var option = document.createElement('option');
              option.value = account;
              option.text = account;
              select.appendChild(option);
            });
          }
        })
        .withFailureHandler(function(error) {
          console.error('[CLIENT] Error loading accounts:', error);
          var select = document.getElementById('defaultAccount');
          var option = document.createElement('option');
          option.value = '';
          option.text = '-- Ошибка загрузки счетов --';
          option.disabled = true;
          select.appendChild(option);
        })
        .pfGetAccountsList();
    }
    
    function handlePreview() {
      // Check if file is selected
      var fileInput = document.getElementById('fileInput');
      if (!fileInput.files || fileInput.files.length === 0) {
        showError('Сначала выберите файл');
        return;
      }
      
      // If fileContent is not set, try to read it again
      if (!fileContent) {
        var file = fileInput.files[0];
        if (file) {
          var reader = new FileReader();
          reader.onload = function(e) {
            fileContent = e.target.result;
            if (fileContent) {
              // Retry preview
              handlePreview();
            } else {
              showError('Не удалось прочитать содержимое файла');
            }
          };
          reader.onerror = function() {
            showError('Ошибка при чтении файла');
          };
          reader.readAsText(file, 'UTF-8');
          return; // Wait for file to be read
        } else {
          showError('Сначала выберите файл');
          return;
        }
      }
      
      var defaultAccount = document.getElementById('defaultAccount').value;
      var defaultCurrency = document.getElementById('defaultCurrency').value;
      
      console.log('[CLIENT] Preview clicked, defaultAccount:', defaultAccount, 'defaultCurrency:', defaultCurrency);
      
      if (!defaultAccount || defaultAccount.trim() === '') {
        showError('Пожалуйста, выберите счет по умолчанию. Если список пуст, создайте счет в листе "Счета" и обновите страницу.');
        return;
      }
      
      // Check if there's already preview data
      if (previewData) {
        var confirmReplace = confirm('Уже есть данные предпросмотра. Заменить их новыми?');
        if (!confirmReplace) {
          return;
        }
        // Reset preview data
        previewData = null;
        document.getElementById('commitBtn').disabled = true;
        document.getElementById('commitWithReviewBtn').disabled = true;
        document.getElementById('stats').style.display = 'none';
      }
      
      document.getElementById('previewBtn').disabled = true;
      document.getElementById('message').innerHTML = '<div>Обработка файла...</div>';
      
      // Process in steps with real progress
      processImportWithProgress(fileContent, defaultAccount, defaultCurrency);
    }
    
    function handleCommit() {
      commitImport(false);
    }
    
    function handleCommitWithReview() {
      commitImport(true);
    }
    
    function commitImport(includeNeedsReview) {
      console.log('[CLIENT] commitImport called, includeNeedsReview: ' + includeNeedsReview);
      
      if (!previewData) {
        console.log('[CLIENT] ERROR: No preview data');
        showError('Сначала выполните предпросмотр');
        return;
      }
      
      console.log('[CLIENT] Preview data exists, starting import...');
      
      document.getElementById('commitBtn').disabled = true;
      document.getElementById('commitWithReviewBtn').disabled = true;
      
      // Show progress bar
      showProgress('Начало импорта...', 0);
      
      var startTime = new Date().getTime();
      var timeoutId = setTimeout(function() {
        console.log('[CLIENT] WARNING: Import timeout after 5 minutes');
        hideProgress();
        showError('Импорт занял слишком много времени. Проверьте логи Apps Script.');
        document.getElementById('commitBtn').disabled = false;
        document.getElementById('commitWithReviewBtn').disabled = false;
      }, 5 * 60 * 1000); // 5 minutes timeout
      
      console.log('[CLIENT] Calling pfCommitImport at ' + new Date().toISOString());
      
      updateProgress('Чтение данных из листа предпросмотра...', 10);
      
      google.script.run
        .withSuccessHandler(function(result) {
          clearTimeout(timeoutId);
          var elapsed = new Date().getTime() - startTime;
          console.log('[CLIENT] pfCommitImport SUCCESS after ' + elapsed + ' ms');
          console.log('[CLIENT] Result: ' + JSON.stringify(result));
          
          if (!result) {
            console.log('[CLIENT] ERROR: Result is null');
            hideProgress();
            showError('Ошибка: сервер вернул пустой результат');
            document.getElementById('commitBtn').disabled = false;
            document.getElementById('commitWithReviewBtn').disabled = false;
            return;
          }
          
          if (result.success) {
            updateProgress('Импорт завершен успешно!', 100);
            setTimeout(function() {
              hideProgress();
              document.getElementById('message').innerHTML = 
                '<div class="success">' + result.message + '</div>';
              // Reset
              previewData = null;
              document.getElementById('fileInput').value = '';
              fileContent = null;
              document.getElementById('stats').style.display = 'none';
              document.getElementById('commitBtn').disabled = true;
              document.getElementById('commitWithReviewBtn').disabled = true;
            }, 1000);
          } else {
            console.log('[CLIENT] ERROR: Import failed: ' + (result.message || 'Unknown error'));
            hideProgress();
            showError(result.message || 'Ошибка при импорте');
            document.getElementById('commitBtn').disabled = false;
            document.getElementById('commitWithReviewBtn').disabled = false;
          }
        })
        .withFailureHandler(function(error) {
          clearTimeout(timeoutId);
          var elapsed = new Date().getTime() - startTime;
          console.log('[CLIENT] pfCommitImport FAILURE after ' + elapsed + ' ms');
          console.log('[CLIENT] Error: ' + JSON.stringify(error));
          console.log('[CLIENT] Error message: ' + (error.message || error.toString()));
          console.log('[CLIENT] Error stack: ' + (error.stack || 'No stack'));
          
          hideProgress();
          showError('Ошибка при импорте: ' + (error.message || error.toString()) + '. Проверьте логи Apps Script.');
          document.getElementById('commitBtn').disabled = false;
          document.getElementById('commitWithReviewBtn').disabled = false;
        })
        .pfCommitImport(includeNeedsReview);
    }
    
    function showStats(stats) {
      document.getElementById('statTotal').textContent = stats.total;
      document.getElementById('statValid').textContent = stats.valid;
      document.getElementById('statReview').textContent = stats.needsReview;
      document.getElementById('statDuplicates').textContent = stats.duplicates;
      document.getElementById('stats').style.display = 'block';
    }
    
    function showError(message) {
      document.getElementById('message').innerHTML = 
        '<div class="error">' + message + '</div>';
    }
    
    function showProgress(text, percent) {
      document.getElementById('progress').style.display = 'block';
      document.getElementById('progressText').textContent = text;
      document.getElementById('progressBar').style.width = percent + '%';
    }
    
    function updateProgress(text, percent) {
      document.getElementById('progressText').textContent = text;
      document.getElementById('progressBar').style.width = percent + '%';
    }
    
    function hideProgress() {
      document.getElementById('progress').style.display = 'none';
      document.getElementById('progressBar').style.width = '0%';
    }
    
    /**
     * Process import in steps with real progress updates.
     */
    function processImportWithProgress(fileContent, defaultAccount, defaultCurrency) {
      var options = {
        defaultAccount: defaultAccount,
        defaultCurrency: defaultCurrency
      };
      
      // Check if file is PDF
      var isPdf = fileName && fileName.toLowerCase().endsWith('.pdf');
      
      if (isPdf) {
        // For PDF files, parse directly
        showProgress('Обработка PDF файла...', 5);
        updateProgress('Извлечение текста из PDF (может занять некоторое время)...', 10);
        
        google.script.run
          .withSuccessHandler(function(parseResult) {
            if (parseResult.count === 0) {
              hideProgress();
              showError('PDF файл не содержит транзакций или не удалось распознать банк. Поддерживаются выписки Сбербанка и Тинькофф.');
              document.getElementById('previewBtn').disabled = false;
              return;
            }
            
            updateProgress('Найдено транзакций: ' + parseResult.count + '. Обработка данных...', 30);
            
            // Step 3: Process data in batches
            processDataInBatches(parseResult.rawData, 'pdf', options, parseResult.count);
          })
          .withFailureHandler(function(error) {
            hideProgress();
            showError('Ошибка при обработке PDF: ' + (error.message || error.toString()) + '. Убедитесь, что файл является выпиской Сбербанка, Тинькофф или Яндекс.');
            document.getElementById('previewBtn').disabled = false;
          })
          .pfParsePdfFile(fileContent, fileName, options);
      } else {
        // For text files (CSV), use existing flow
        // Step 1: Detect format (5%)
        showProgress('Определение формата файла...', 5);
        google.script.run
          .withSuccessHandler(function(formatInfo) {
            if (!formatInfo.detected) {
              hideProgress();
              showError('Формат файла не поддерживается. Используйте CSV файл или выписку Сбербанка.');
              document.getElementById('previewBtn').disabled = false;
              return;
            }
            
            // Step 2: Parse file (5-30%)
            updateProgress('Парсинг файла...', 10);
            google.script.run
              .withSuccessHandler(function(parseResult) {
                if (parseResult.count === 0) {
                  hideProgress();
                  showError('Файл пуст или не содержит данных для импорта');
                  document.getElementById('previewBtn').disabled = false;
                  return;
                }
                
                updateProgress('Найдено транзакций: ' + parseResult.count + '. Обработка данных...', 15);
                
                // Step 3: Process data in batches
                processDataInBatches(parseResult.rawData, formatInfo.importerType, options, parseResult.count);
              })
              .withFailureHandler(function(error) {
                hideProgress();
                showError('Ошибка при парсинге файла: ' + (error.message || error.toString()));
                document.getElementById('previewBtn').disabled = false;
              })
              .pfParseFileContent(fileContent, formatInfo.importerType, options);
          })
          .withFailureHandler(function(error) {
            hideProgress();
            showError('Ошибка при определении формата: ' + (error.message || error.toString()));
            document.getElementById('previewBtn').disabled = false;
          })
          .pfDetectFileFormat(fileContent);
      }
    }
    
    /**
     * Process data in batches with progress updates.
     */
    function processDataInBatches(rawData, importerType, options, totalCount) {
      var allTransactions = [];
      var totalStats = {
        valid: 0,
        needsReview: 0,
        duplicates: 0,
        errors: 0
      };
      // Note: batchSize is defined server-side in Constants.js as PF_IMPORT_BATCH_SIZE
      // For client-side, we use smaller batches for PDF (more complex parsing)
      // and regular size for CSV
      var batchSize = importerType === 'pdf' ? 50 : 200; // Smaller batches for PDF to avoid timeout
      var processed = 0;
      var existingKeys = null; // Store deduplication keys across batches
      var timeoutId = null;
      
      // Store total count in options for server-side function
      options._totalCount = totalCount;
      
      // Load existing keys ONCE before processing batches (to avoid calling slow function on each batch)
      console.log('[CLIENT] Starting to load existing keys...');
      updateProgress('Загрузка существующих транзакций для проверки дубликатов...', 16);
      
      var keysLoadStartTime = Date.now();
      google.script.run
        .withSuccessHandler(function(keys) {
          var keysLoadDuration = Date.now() - keysLoadStartTime;
          console.log('[CLIENT] Keys loaded successfully in', keysLoadDuration, 'ms');
          console.log('[CLIENT] Keys count:', keys ? Object.keys(keys).length : 0);
          existingKeys = keys || {};
          // Start processing batches
          console.log('[CLIENT] Starting first batch processing...');
          processNextBatch();
        })
        .withFailureHandler(function(error) {
          var keysLoadDuration = Date.now() - keysLoadStartTime;
          console.error('[CLIENT] Failed to load keys after', keysLoadDuration, 'ms');
          console.error('[CLIENT] Keys load error:', error);
          // If loading keys fails, start with empty keys (will still work, just won't detect duplicates with existing)
          console.warn('[CLIENT] Starting with empty keys due to error');
          existingKeys = {};
          processNextBatch();
        })
        .pfGetExistingTransactionKeys();
      
      console.log('[CLIENT] pfGetExistingTransactionKeys call initiated');
      
      return; // Don't call processNextBatch() here - it will be called after keys are loaded
      
      function processNextBatch() {
        console.log('[CLIENT] processNextBatch called, processed:', processed, 'totalCount:', totalCount);
        
        // Clear any existing timeout
        if (timeoutId) {
          clearTimeout(timeoutId);
          timeoutId = null;
        }
        
        if (processed >= totalCount) {
          console.log('[CLIENT] All processed, writing preview');
          // All processed, write preview
          writePreview();
          return;
        }
        
        // Calculate progress (17% to 85%) - adjusted because keys loading takes 1-2%
        var progress = 17 + Math.floor((processed / totalCount) * 68);
        var remaining = totalCount - processed;
        updateProgress('Обработка транзакций: ' + processed + ' из ' + totalCount + ' (' + remaining + ' осталось)...', progress);
        
        // Extract only the batch we need (not the entire array)
        var batchEnd = Math.min(processed + batchSize, totalCount);
        var batchData = rawData.slice(processed, batchEnd);
        
        console.log('[CLIENT] Batch data extracted:', {
          processed: processed,
          batchEnd: batchEnd,
          batchSize: batchData.length,
          totalCount: totalCount,
          existingKeysCount: existingKeys ? Object.keys(existingKeys).length : 0
        });
        
        // Process batch - pass only the batch data, not entire array
        // Also pass current processed count and existing keys so server knows the offset
        var batchOptions = Object.assign({}, options);
        batchOptions._startIndex = processed;
        // Always pass existingKeys (loaded once at the beginning)
        batchOptions._existingKeys = existingKeys || {};
        
        console.log('[CLIENT] Calling pfProcessDataBatch with:', {
          batchDataLength: batchData.length,
          importerType: importerType,
          batchSize: batchSize,
          processed: processed,
          optionsKeys: Object.keys(batchOptions)
        });
        
        // Set timeout (5 minutes)
        timeoutId = setTimeout(function() {
          console.error('[CLIENT] TIMEOUT after 5 minutes!');
          console.error('[CLIENT] Last processed:', processed, 'totalCount:', totalCount);
          console.error('[CLIENT] Check server logs for detailed information');
          hideProgress();
          showError('Таймаут при обработке (5 минут). Обработано: ' + processed + ' из ' + totalCount + '. Проверьте логи в Apps Script для деталей. Попробуйте уменьшить размер файла или разбить его на части.');
          document.getElementById('previewBtn').disabled = false;
        }, 300000);
        
        console.log('[CLIENT] Timeout set for 5 minutes, starting server call...');
        
        var callStartTime = Date.now();
        console.log('[CLIENT] Starting google.script.run.pfProcessDataBatch at', new Date().toISOString());
        
        google.script.run
          .withSuccessHandler(function(batchResult) {
            var callDuration = Date.now() - callStartTime;
            console.log('[CLIENT] pfProcessDataBatch SUCCESS after', callDuration, 'ms');
            console.log('[CLIENT] Batch result received:', batchResult);
            console.log('[CLIENT] Batch result type:', typeof batchResult);
            console.log('[CLIENT] Batch result is null?', batchResult === null);
            console.log('[CLIENT] Batch result is undefined?', batchResult === undefined);
            
            // Check if result is null or invalid
            if (!batchResult || typeof batchResult !== 'object') {
              console.error('[CLIENT] ERROR: batchResult is null or invalid!', batchResult);
              hideProgress();
              showError('Ошибка: сервер вернул неверный результат. Попробуйте уменьшить размер батча или разбить файл на части.');
              document.getElementById('previewBtn').disabled = false;
              return;
            }
            
            console.log('[CLIENT] Batch result details:', {
              transactionsCount: batchResult.transactions ? batchResult.transactions.length : 'MISSING',
              stats: batchResult.stats,
              processed: batchResult.processed,
              total: batchResult.total,
              hasMore: batchResult.hasMore,
              existingKeysCount: batchResult.existingKeys ? Object.keys(batchResult.existingKeys).length : 0
            });
            
            if (!batchResult.transactions || !Array.isArray(batchResult.transactions)) {
              console.error('[CLIENT] ERROR: batchResult.transactions is missing or not an array!', batchResult.transactions);
              hideProgress();
              showError('Ошибка: сервер вернул результат без транзакций. Попробуйте уменьшить размер батча.');
              document.getElementById('previewBtn').disabled = false;
              return;
            }
            
            if (timeoutId) {
              clearTimeout(timeoutId);
              timeoutId = null;
            }
            
            allTransactions = allTransactions.concat(batchResult.transactions);
            totalStats.valid += batchResult.stats.valid;
            totalStats.needsReview += batchResult.stats.needsReview;
            totalStats.duplicates += batchResult.stats.duplicates;
            totalStats.errors += batchResult.stats.errors;
            processed = batchResult.processed;
            
            console.log('[CLIENT] Updated totals:', {
              allTransactionsCount: allTransactions.length,
              totalStats: totalStats,
              processed: processed
            });
            
            // Update existing keys for next batch
            if (batchResult.existingKeys) {
              existingKeys = batchResult.existingKeys;
            }
            
            // Continue with next batch
            if (batchResult.hasMore) {
              console.log('[CLIENT] Has more batches, continuing...');
              setTimeout(processNextBatch, 50); // Small delay to allow UI update
            } else {
              console.log('[CLIENT] No more batches, writing preview');
              // All processed, write preview
              writePreview();
            }
          })
          .withFailureHandler(function(error) {
            var callDuration = Date.now() - callStartTime;
            console.error('[CLIENT] pfProcessDataBatch FAILED after', callDuration, 'ms');
            console.error('[CLIENT] Error details:', error);
            console.error('[CLIENT] Error message:', error.message);
            console.error('[CLIENT] Error stack:', error.stack);
            
            if (timeoutId) {
              clearTimeout(timeoutId);
              timeoutId = null;
            }
            hideProgress();
            var errorMsg = 'Ошибка при обработке данных (строка ' + (processed + 1) + '): ' + 
                          (error.message || error.toString());
            if (error.stack) {
              errorMsg += '\nДетали: ' + error.stack.substring(0, 500);
            }
            showError(errorMsg);
            document.getElementById('previewBtn').disabled = false;
          })
          .pfProcessDataBatch(JSON.stringify(batchData), importerType, batchOptions, batchSize, processed);
        
        console.log('[CLIENT] google.script.run.pfProcessDataBatch call initiated');
      }
      
      function writePreview() {
        updateProgress('Запись предпросмотра в таблицу...', 90);
        google.script.run
          .withSuccessHandler(function(preview) {
            hideProgress();
            previewData = preview;
            preview.stats.total = allTransactions.length;
            preview.stats.valid = totalStats.valid;
            preview.stats.needsReview = totalStats.needsReview;
            preview.stats.duplicates = totalStats.duplicates;
            showStats(preview.stats);
            document.getElementById('message').innerHTML = 
              '<div class="success">Предпросмотр готов. Проверьте лист "' + preview.stagingSheetName + '"</div>';
            document.getElementById('previewBtn').disabled = false;
            document.getElementById('commitBtn').disabled = false;
            document.getElementById('commitWithReviewBtn').disabled = false;
          })
          .withFailureHandler(function(error) {
            hideProgress();
            showError('Ошибка при создании предпросмотра: ' + (error.message || error.toString()));
            document.getElementById('previewBtn').disabled = false;
          })
          .pfWritePreview(JSON.stringify(allTransactions));
      }
      
      // Note: processNextBatch() will be called after keys are loaded
      // (see the google.script.run.pfGetExistingTransactionKeys_() call above)
    }
  </script>
</body>
</html>

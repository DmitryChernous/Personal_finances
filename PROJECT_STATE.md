# Project state (snapshot)

Дата: 2026-01-24 (обновлено)

Этот файл фиксирует текущее состояние репозитория перед началом разработки основной логики.

## Git

- Ветка: `main` (tracking: `origin/main`)
- Remote: `https://github.com/DmitryChernous/Personal_finances.git`
- Рабочая директория: см. `git status`

## Локальная привязка Google Apps Script (clasp)

- В репозитории **есть локальный** файл `.clasp.json` (он **в `.gitignore`** и не должен коммититься).
- `.clasp.json` содержит привязку к конкретному Apps Script проекту и контейнерной таблице:
  - `scriptId`: (локально)
  - `parentId` (Spreadsheet ID): (локально)
  - `rootDir`: `src`
- Шаблон для переноса/восстановления: `.clasp.json.example`

## Node / зависимости

- Node.js: `v24.13.0`
- npm: `11.6.2`
- Основная dev-зависимость: `@google/clasp@3.1.3`

## Структура проекта

- `src/appsscript.json` — манифест Apps Script (V8, Europe/Moscow)
- `src/Code.js` — меню в Google Sheets + `pfSetup()` + `onEdit()` обработчик
- `src/Setup.js` — идемпотентная инициализация (листы, шапки, валидации, именованные диапазоны, Reports, Dashboard)
- `src/Validation.js` — валидация и нормализация транзакций, подсветка ошибок
- `src/Reports.js` — генерация отчётов с формулами (доходы/расходы, категории, остатки)
- `src/Dashboard.js` — инициализация дашборда с KPI и графиками (pie chart для категорий)
- `src/TestData.js` — генерация тестовых данных для удобного тестирования (счета, категории, транзакции)
- `src/Sheets.js` — утилиты для листов + применение локализации + фильтры
- `src/I18n.js` — словари RU/EN (имена листов, заголовки, меню)
- `src/Settings.js` — хранение настроек в листе Settings/Настройки (язык, версия схемы, валюта)
- `src/Schema.js` — схемы листов (Transactions, Accounts, Categories)
- `TRANSACTIONS_SCHEMA.md` — спецификация схемы транзакций
- `README.md` — инструкции по подключению и работе через `clasp`

## Что сейчас реализовано в Apps Script

- `onOpen()` добавляет меню **Personal finances** в Google Sheets.
- Пункт меню **Setup (создать листы)** вызывает `pfSetup()`, который:
  - Устанавливает локаль таблицы `ru_RU`
  - Создаёт/обновляет листы: `Транзакции`, `Категории`, `Счета`, `Настройки`, `Инструкция`, `Отчеты`, `Дашборд`
  - Устанавливает шапки для всех таблиц (с учётом выбранного языка RU/EN)
  - Применяет автофильтры, frozen row, форматы (дата `dd.mm.yyyy`, сумма `0.00`)
  - Настраивает валидации: `Type`, `Status` (строгие списки), `Currency` (RUB/USD/EUR), `Account`/`AccountTo` (из справочника), `Category` (из справочника), `Amount > 0`
  - Создаёт именованные диапазоны `PF_ACCOUNTS` и `PF_CATEGORIES` для выпадающих списков
  - Заполняет лист `Инструкция/Help` минимальным "быстрым стартом" (если пустой)
  - Сохраняет версию схемы и валюту по умолчанию в `Settings`
- В меню есть выбор языка (RU/EN); выбранный язык сохраняется в листе настроек и применяется к именам листов и заголовкам.
- `pfSetup()` идемпотентен: повторный запуск не ломает данные и не дублирует шапки.
- **Генерация тестовых данных**: пункт меню "Заполнить тестовыми данными" создаёт реалистичные тестовые данные (5 счетов, 15 категорий, ~60 транзакций за последние 3 месяца) для удобного тестирования функционала.
- **Этап 2 завершён**: добавлена валидация и нормализация транзакций:
  - Автоматическая валидация при редактировании (`onEdit()`)
  - Проверка обязательных полей и бизнес-правил (`pfValidateTransactionRow_()`)
  - Нормализация данных (трим, автозаполнение `Source`, `Status`, `Currency`) (`pfNormalizeTransactionRow_()`)
  - Подсветка ошибок красным цветом (`pfHighlightErrors_()`)
  - Пункты меню: "Проверить все транзакции", "Пометить на проверку"

## Команды (npm scripts)

- `npm run login` — авторизация clasp
- `npm run create:sheets` — создать Google Sheet + контейнерный Apps Script, rootDir=`src`
- `npm run push` / `npm run push:force` — залить код в Apps Script
- `npm run pull` — скачать код из Apps Script
- `npm run open` — открыть контейнерный проект в браузере
- `npm run logs` — посмотреть логи

## Примечания перед разработкой основной части

- Идентификаторы `scriptId` / `parentId` **не сохраняем в git** (оставляем только локально в `.clasp.json`).
- Таблица **русскоязычная**; синтаксис формул/форматы должны быть совместимы с локалью `ru_RU` (см. `SHEETS_LOCALE.md`).
- Язык интерфейса (RU/EN) определяет имена листов/заголовки через словари в `src/I18n.js`.
- **Этап 1 (базовая часть) завершён**: `pfSetup()` создаёт полную структуру таблицы "из коробки".
- **Этап 2 (UX для транзакций) завершён и протестирован**: валидация, нормализация, подсветка ошибок, пометка на проверку. ✅ Все тесты пройдены.
- **Этап 3 (базовая аналитика) завершён и улучшен**: лист Reports с формулами для доходов/расходов, топ категорий, остатков по счетам, месячного cashflow. ✅
  - **Важно**: Топ категорий и месячный cashflow реализованы через скриптовый расчет (не QUERY формула) из-за бага Google Sheets с #N/A при программной установке QUERY.
  - **Улучшения**: Остатки по счетам теперь учитывают начальный баланс из листа Accounts и переводы (transfer).
  - **Новое**: Реализован месячный cashflow за последние 12 месяцев (доходы, расходы, итого по каждому месяцу).
- **Этап 4 (Dashboard) завершён**: лист Dashboard с KPI (доход/расход/баланс, средний расход) и графиком расходов по категориям (pie chart). ✅
  - **Важно**: Данные для графика категорий также генерируются скриптом (не QUERY) для избежания проблем с #N/A.
- **Исправлена проблема с QUERY формулами**: после множественных попыток обхода бага Google Sheets (#N/A при программной установке QUERY), принято решение использовать скриптовый расчет для топ категорий в Reports и Dashboard. Данные обновляются при вызове "Обновить отчёты" / "Обновить дашборд".
- **Доработка Этапов 3-4 завершена и протестирована**: улучшен расчет остатков по счетам, добавлен месячный cashflow, исправлены ошибки в формулах Dashboard. ✅
- Следующий шаг разработки: **Этап 5** — Подготовка архитектуры импорта.


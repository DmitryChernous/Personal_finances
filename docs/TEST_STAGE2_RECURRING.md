# План тестирования Stage 2: Регулярные платежи

## Подготовка

### Шаг 1: Setup
1. Запустите: **Personal finances → Setup (создать листы)**
2. Проверьте, что создался лист **"Регулярные платежи"** (или "Recurring Transactions" если язык EN)
3. Проверьте заголовки листа:
   - Название
   - Тип
   - Частота
   - День месяца
   - День недели
   - Дата начала
   - Дата окончания
   - Счет
   - Счет (получатель)
   - Сумма
   - Валюта
   - Категория
   - Подкатегория
   - Место/контрагент
   - Комментарий
   - Активно
   - Последнее создание

### Шаг 2: Подготовка данных
1. Убедитесь, что в листе **"Счета"** есть хотя бы один счет (например, "Карта Сбер")
2. Убедитесь, что в листе **"Категории"** есть категории (можно использовать тестовые данные)

---

## Тест 1: Ежемесячный платеж (Monthly)

### Настройка:
1. Перейдите на лист **"Регулярные платежи"**
2. Добавьте строку:
   - **Название:** "Аренда квартиры"
   - **Тип:** expense
   - **Частота:** monthly
   - **День месяца:** 5
   - **День недели:** (оставить пустым)
   - **Дата начала:** 01.01.2026
   - **Дата окончания:** (оставить пустым)
   - **Счет:** Карта Сбер
   - **Сумма:** 30000
   - **Валюта:** RUB
   - **Категория:** Жильё
   - **Подкатегория:** Аренда
   - **Активно:** (оставить пустым или true)

### Выполнение:
1. Запустите: **Personal finances → Создать регулярные платежи**
2. Проверьте сообщение (должно показать количество созданных транзакций)

### Ожидаемый результат:
- Если сегодня >= 5 января 2026:
  - В листе **"Транзакции"** должна появиться транзакция:
    - Дата: 05.01.2026 (или текущая дата, если сегодня >= 5 января)
    - Тип: expense
    - Счет: Карта Сбер
    - Сумма: 30000
    - Категория: Жильё
    - Подкатегория: Аренда
    - Источник: manual
    - Статус: ok
- В листе **"Регулярные платежи"** в колонке **"Последнее создание"** должна появиться дата созданной транзакции

### Повторный запуск:
1. Запустите еще раз: **Personal finances → Создать регулярные платежи**
2. **Ожидаемый результат:** Новая транзакция НЕ должна создаться (уже создана для текущего месяца)

---

## Тест 2: Еженедельный платеж (Weekly)

### Настройка:
1. Добавьте строку:
   - **Название:** "Подписка на сервис"
   - **Тип:** expense
   - **Частота:** weekly
   - **День месяца:** (оставить пустым)
   - **День недели:** 1 (понедельник)
   - **Дата начала:** 20.01.2026 (или любая дата в прошлом)
   - **Счет:** Карта Сбер
   - **Сумма:** 500
   - **Валюта:** RUB
   - **Категория:** Развлечения
   - **Активно:** (оставить пустым)

### Выполнение:
1. Запустите: **Personal finances → Создать регулярные платежи**

### Ожидаемый результат:
- Если прошло >= 7 дней с даты начала (или LastCreated):
  - В листе **"Транзакции"** должна появиться транзакция
  - Дата должна быть понедельник (или ближайший прошедший понедельник)

---

## Тест 3: Ежегодный платеж (Yearly)

### Настройка:
1. Добавьте строку:
   - **Название:** "Страховка"
   - **Тип:** expense
   - **Частота:** yearly
   - **День месяца:** 15
   - **Дата начала:** 15.01.2025 (год назад)
   - **Счет:** Карта Сбер
   - **Сумма:** 10000
   - **Валюта:** RUB
   - **Категория:** Здоровье
   - **Активно:** (оставить пустым)

### Выполнение:
1. Запустите: **Personal finances → Создать регулярные платежи**

### Ожидаемый результат:
- Если прошло >= 12 месяцев с даты начала:
  - В листе **"Транзакции"** должна появиться транзакция с датой 15.01.2026 (или текущая дата, если сегодня >= 15 января)

---

## Тест 4: Доход (Income) - Зарплата

### Настройка:
1. Добавьте строку:
   - **Название:** "Зарплата"
   - **Тип:** income
   - **Частота:** monthly
   - **День месяца:** 5
   - **Дата начала:** 01.01.2026
   - **Счет:** Карта Сбер
   - **Сумма:** 80000
   - **Валюта:** RUB
   - **Категория:** Зарплата
   - **Активно:** (оставить пустым)

### Выполнение:
1. Запустите: **Personal finances → Создать регулярные платежи**

### Ожидаемый результат:
- В листе **"Транзакции"** должна появиться транзакция с типом **income**

---

## Тест 5: Перевод (Transfer)

### Настройка:
1. Добавьте строку:
   - **Название:** "Перевод на вклад"
   - **Тип:** transfer
   - **Частота:** monthly
   - **День месяца:** 10
   - **Дата начала:** 01.01.2026
   - **Счет:** Карта Сбер
   - **Счет (получатель):** Вклад
   - **Сумма:** 10000
   - **Валюта:** RUB
   - **Категория:** (оставить пустым)
   - **Активно:** (оставить пустым)

### Выполнение:
1. Запустите: **Personal finances → Создать регулярные платежи**

### Ожидаемый результат:
- В листе **"Транзакции"** должна появиться транзакция с типом **transfer**
- Должны быть заполнены **Счет** и **Счет (получатель)**

---

## Тест 6: Неактивный платеж

### Настройка:
1. Добавьте строку (как в Тесте 1), но установите:
   - **Активно:** false

### Выполнение:
1. Запустите: **Personal finances → Создать регулярные платежи**

### Ожидаемый результат:
- Транзакция НЕ должна создаться

---

## Тест 7: Дата окончания (EndDate)

### Настройка:
1. Добавьте строку:
   - **Название:** "Временная подписка"
   - **Тип:** expense
   - **Частота:** monthly
   - **День месяца:** 1
   - **Дата начала:** 01.01.2026
   - **Дата окончания:** 31.12.2025 (в прошлом)
   - **Счет:** Карта Сбер
   - **Сумма:** 1000
   - **Валюта:** RUB
   - **Активно:** (оставить пустым)

### Выполнение:
1. Запустите: **Personal finances → Создать регулярные платежи**

### Ожидаемый результат:
- Транзакция НЕ должна создаться (EndDate в прошлом)

---

## Тест 8: Валидации

### Проверка валидаций:
1. Попробуйте ввести недопустимые значения:
   - **Тип:** не из списка (expense/income/transfer)
   - **Частота:** не из списка (weekly/monthly/quarterly/yearly)
   - **День месяца:** число < 1 или > 31
   - **День недели:** число < 1 или > 7
   - **Сумма:** отрицательное число или 0

### Ожидаемый результат:
- Google Sheets должен показывать ошибки валидации
- Недопустимые значения не должны приниматься

---

## Тест 9: Форматирование

### Проверка:
1. Проверьте форматирование колонок:
   - **Сумма:** должно быть форматировано как число с разделителями (10 000,00)
   - **Дата начала/Дата окончания/Последнее создание:** должно быть форматировано как дата (dd.MM.yyyy)

---

## Тест 10: Повторное создание (дедупликация)

### Настройка:
1. Используйте платеж из Теста 1
2. Убедитесь, что **"Последнее создание"** заполнено (дата в текущем месяце)

### Выполнение:
1. Запустите: **Personal finances → Создать регулярные платежи** еще раз

### Ожидаемый результат:
- Новая транзакция НЕ должна создаться (уже создана для текущего месяца)
- В сообщении должно быть указано: "пропущено: X"

---

## Известные ограничения

1. **Weekly платежи:** Логика проверки дня недели может требовать доработки
2. **Quarterly платежи:** Не протестированы в этом плане (можно добавить аналогично Monthly)
3. **Edge cases:** 
   - День месяца 31 для месяцев с 30 днями (должно использовать последний день месяца)
   - Переход через год для yearly платежей

---

## Что проверить в логах (если что-то не работает)

1. Откройте Apps Script редактор (Расширения → Apps Script)
2. View → Logs
3. Запустите функцию
4. Проверьте логи на наличие ошибок или предупреждений

---

## Результаты тестирования

Заполните после тестирования:

- [ ] Тест 1 (Monthly): ✅ / ❌
- [ ] Тест 2 (Weekly): ✅ / ❌
- [ ] Тест 3 (Yearly): ✅ / ❌
- [ ] Тест 4 (Income): ✅ / ❌
- [ ] Тест 5 (Transfer): ✅ / ❌
- [ ] Тест 6 (Inactive): ✅ / ❌
- [ ] Тест 7 (EndDate): ✅ / ❌
- [ ] Тест 8 (Validations): ✅ / ❌
- [ ] Тест 9 (Formatting): ✅ / ❌
- [ ] Тест 10 (Deduplication): ✅ / ❌

**Примечания:**
(Запишите любые проблемы или неожиданное поведение)

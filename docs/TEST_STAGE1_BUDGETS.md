# План тестирования Этапа 1: Бюджетирование

**Дата:** 2026-01-25  
**Этап:** TASK-001 - Бюджетирование

---

## Подготовка к тестированию

### 1. Загрузка кода в Apps Script
- [ ] Выполнить `npm run push` для загрузки изменений
- [ ] Убедиться, что нет ошибок компиляции в Apps Script редакторе

### 2. Инициализация
- [ ] Открыть Google Sheets таблицу
- [ ] Запустить меню: **Personal finances → Setup (создать листы)**
- [ ] Проверить, что создан лист **"Бюджеты"** (или "Budgets" для EN)
- [ ] Проверить, что лист имеет правильные заголовки:
  - Категория
  - Подкатегория
  - Период
  - Значение периода
  - Сумма
  - Факт
  - Остаток
  - Статус
  - % использования
  - Активно
  - Описание

---

## Тест 1: Создание бюджета

### Шаги:
1. Перейти на лист **"Бюджеты"**
2. Добавить новую строку с данными:
   - **Категория:** Продукты (должна быть из справочника)
   - **Период:** month
   - **Значение периода:** 2026-01 (текущий месяц в формате YYYY-MM)
   - **Сумма:** 10000
   - **Активно:** true (или оставить пустым)

### Ожидаемый результат:
- ✅ Валидация работает: можно выбрать категорию из выпадающего списка
- ✅ Валидация периода: можно выбрать только "month" или "year"
- ✅ Валидация суммы: принимает только числа > 0
- ✅ Форматирование: колонка "Сумма" отформатирована как число с 2 знаками

---

## Тест 2: Расчет факта бюджета

### Предварительные условия:
- В листе **"Транзакции"** есть транзакции с категорией "Продукты" за текущий месяц
- Статус транзакций = "ok"
- Тип транзакций = "expense"

### Шаги:
1. Создать бюджет для категории "Продукты" на текущий месяц (сумма: 10000)
2. В меню выбрать: **Personal finances → Обновить бюджеты**

### Ожидаемый результат:
- ✅ Колонка **"Факт"** заполнена суммой всех транзакций категории "Продукты" за текущий месяц
- ✅ Колонка **"Остаток"** = Сумма - Факт
- ✅ Колонка **"Статус"** содержит одно из: "В норме", "Предупреждение", "Превышен"
- ✅ Колонка **"% использования"** = (Факт / Сумма) * 100
- ✅ Форматирование: "Факт" и "Остаток" как числа, "% использования" как процент

---

## Тест 3: Статусы бюджетов

### Тест 3.1: Статус "В норме"
**Условия:**
- План: 10000
- Факт: 5000 (50% использования, остаток 50% > 20%)

**Ожидаемый результат:**
- ✅ Статус = "В норме" (или "OK" для EN)
- ✅ Фон строки не изменен (белый/светлый)

### Тест 3.2: Статус "Предупреждение"
**Условия:**
- План: 10000
- Факт: 8500 (85% использования, остаток 15% <= 20%)

**Ожидаемый результат:**
- ✅ Статус = "Предупреждение" (или "Warning" для EN)
- ✅ Фон строки = желтый (#fff4cc)

### Тест 3.3: Статус "Превышен"
**Условия:**
- План: 10000
- Факт: 12000 (120% использования)

**Ожидаемый результат:**
- ✅ Статус = "Превышен" (или "Exceeded" для EN)
- ✅ Фон строки = красный (#ffcccc)

---

## Тест 4: Секция "Бюджеты" в Reports

### Шаги:
1. Создать несколько бюджетов на текущий месяц
2. Запустить меню: **Personal finances → Обновить отчёты**

### Ожидаемый результат:
- ✅ В листе **"Отчеты"** есть секция "Бюджеты (текущий месяц)"
- ✅ Таблица содержит колонки: Категория, План, Факт, Остаток, Статус, % использования
- ✅ Данные соответствуют данным из листа "Бюджеты"
- ✅ Превышенные бюджеты подсвечены красным
- ✅ Форматирование чисел и процентов корректное

---

## Тест 5: Виджеты в Dashboard

### Шаги:
1. Создать бюджеты (включая превышенные)
2. Запустить меню: **Personal finances → Обновить дашборд**

### Ожидаемый результат:
- ✅ В листе **"Дашборд"** есть секция "Показатели бюджетов (текущий месяц)"
- ✅ KPI карточки:
  - **"Бюджетов превышено"** = количество бюджетов со статусом "Превышен"
  - **"Средний % использования"** = средний процент использования всех активных бюджетов
- ✅ Секция "Превышенные бюджеты":
  - Таблица с колонками: Категория, План, Факт, Превышение
  - Только бюджеты со статусом "Превышен"
  - Подсветка красным цветом

---

## Тест 6: Разные периоды

### Тест 6.1: Месячный бюджет
**Шаги:**
1. Создать бюджет:
   - Период: month
   - Значение периода: 2026-01
   - Сумма: 5000
2. Обновить бюджеты

**Ожидаемый результат:**
- ✅ Факт рассчитывается только для транзакций января 2026
- ✅ Транзакции других месяцев не учитываются

### Тест 6.2: Годовой бюджет
**Шаги:**
1. Создать бюджет:
   - Период: year
   - Значение периода: 2026
   - Сумма: 50000
2. Обновить бюджеты

**Ожидаемый результат:**
- ✅ Факт рассчитывается для всех транзакций 2026 года
- ✅ Транзакции других лет не учитываются

---

## Тест 7: Подкатегории

### Шаги:
1. Создать бюджет:
   - Категория: Продукты
   - Подкатегория: Молочные продукты
   - Период: month
   - Значение периода: 2026-01
   - Сумма: 2000
2. В транзакциях есть:
   - Транзакция 1: Категория="Продукты", Подкатегория="Молочные продукты", Сумма=500
   - Транзакция 2: Категория="Продукты", Подкатегория="Хлеб", Сумма=300
3. Обновить бюджеты

### Ожидаемый результат:
- ✅ Факт = 500 (только транзакция 1)
- ✅ Транзакция 2 не учитывается (другая подкатегория)

---

## Тест 8: Неактивные бюджеты

### Шаги:
1. Создать бюджет с "Активно" = false (или пустое)
2. Обновить бюджеты

### Ожидаемый результат:
- ✅ Колонки "Факт", "Остаток", "Статус", "% использования" остаются пустыми
- ✅ Бюджет не учитывается в Reports и Dashboard

---

## Тест 9: Edge cases

### Тест 9.1: Пустой лист Budgets
**Ожидаемый результат:**
- ✅ Reports: секция "Бюджеты" не отображается или пустая
- ✅ Dashboard: KPI показывают 0, список превышенных пуст

### Тест 9.2: Бюджет без транзакций
**Ожидаемый результат:**
- ✅ Факт = 0
- ✅ Остаток = Сумма
- ✅ Статус = "В норме"
- ✅ % использования = 0%

### Тест 9.3: Невалидное значение периода
**Ожидаемый результат:**
- ✅ При невалидном формате PeriodValue (не YYYY-MM или YYYY) факт = 0
- ✅ В логах есть предупреждение

### Тест 9.4: Бюджет на будущий месяц
**Ожидаемый результат:**
- ✅ Бюджет не отображается в Reports (фильтр по текущему месяцу)
- ✅ Факт = 0 (нет транзакций в будущем)

---

## Тест 10: Производительность

### Шаги:
1. Создать 20+ бюджетов
2. В транзакциях 1000+ записей
3. Запустить "Обновить бюджеты"

### Ожидаемый результат:
- ✅ Обновление выполняется за разумное время (< 30 секунд)
- ✅ Нет ошибок таймаута
- ✅ Все бюджеты обновлены корректно

---

## Чеклист финальной проверки

- [ ] Все тесты пройдены
- [ ] Нет ошибок в логах Apps Script
- [ ] Форматирование корректное во всех листах
- [ ] Локализация работает (RU/EN)
- [ ] Меню "Обновить бюджеты" работает
- [ ] Интеграция с Reports работает
- [ ] Интеграция с Dashboard работает
- [ ] Условное форматирование (цвета) работает

---

## Известные ограничения

1. **Дедупликация:** Не реализована (отложена на будущее)
2. **Валидация PeriodValue:** Базовая (формат YYYY-MM или YYYY), но нет строгой проверки валидности даты
3. **Производительность:** При большом количестве бюджетов (>50) может быть медленно

---

## Результаты тестирования

**Дата тестирования:** _______________  
**Тестировщик:** _______________  

**Статус:** [ ] ✅ Пройдено / [ ] ❌ Есть проблемы

**Найденные проблемы:**
1. 
2. 
3. 

**Комментарии:**
_________________________________________________

# Анализ прототипа инструмента учёта личных финансов и план доработок

**Дата:** 31 января 2026  
**Цель документа:** Разобраться в прототипе, оценить соответствие целям учёта личных финансов, собрать замечания и план переработки в один файл для передачи на реализацию.

**Ссылка на прототип (Google Таблица):**  
https://docs.google.com/spreadsheets/d/18Ae4ovzy2y3dsHW_NHxOvRt8h7NAJHqrb60S4pvurUI/edit?gid=1728027484#gid=1728027484

*Примечание: прямой доступ к содержимому таблицы по ссылке недоступен (таймаут). Анализ выполнен по коду и документации репозитория, которые реализуют этот прототип.*

---

## 1. Цели инструмента (по ТЗ)

| № | Цель | Критерий успеха |
|---|------|------------------|
| 1 | **Сбор данных о транзакциях с разных счетов** | Несколько источников (счета/банки), единое место хранения, без дублирования |
| 2 | **Подготовка данных для анализа** | Нормализация, категоризация, единый формат, возможность делать выводы |
| 3 | **Информативные дашборды** | KPI, графики, ключевые показатели для личных финансов, интуитивно понятная подача |

Ниже прототип разбирается по этим трём целям.

---

## 2. Что есть в прототипе (по коду и документации)

### 2.1. Сбор данных с разных счетов

**Реализовано:**

- **Единый лист «Транзакции»** — все операции (ручной ввод, импорт, raw-листы) сводятся в один лист с единой схемой (14 колонок: Дата, Тип, Счет, Счет получателя, Сумма, Валюта, Категория, Подкатегория, Место/контрагент, Комментарий, Теги, Источник, ID источника, Статус).
- **Raw-листы** — листы с именами, начинающимися на `raw` (например, `raw_Сбербанк`, `raw_Яндекс Карта`). Один лист = один счёт. Синхронизация по меню «Синхронизировать с raw-листами»:
  - чтение сырых колонок: ДАТА, ВРЕМЯ, КАТЕГОРИЯ, ОПИСАНИЕ, СУММА, ОСТАТОК СРЕДСТВ, СЧЕТ;
  - нормализация в канонический формат (дата, тип по знаку суммы, счёт из имени листа при пустом поле);
  - дедупликация по паре (Source, SourceId); добавление только новых строк в «Транзакции».
- **Импорт через UI** — CSV, PDF (Сбербанк, Яндекс), выписки в формате Sberbank. Цепочка: загрузка → лист «Импорт (черновик)» → предпросмотр → коммит в «Транзакции» с дедупликацией.
- **Ручной ввод** — прямо в лист «Транзакции» и через сайдбар «Быстрый ввод транзакции».

**Итог по цели 1:** Сбор с разных счетов реализован: raw-листы, импорт файлов, ручной ввод. Всё пишется в один слой «Транзакции».

---

### 2.2. Подготовка данных для анализа

**Реализовано:**

- **Нормализация при синхронизации raw** — дата (dd.mm.yyyy), тип (expense/income по знаку суммы), сумма всегда положительная, подстановка счёта из имени листа, Source = `raw:ИмяЛиста`, SourceId для дедупликации.
- **Валидация и нормализация при редактировании** — `onEdit` на листе «Транзакции»: трим, значения по умолчанию (Source, Status, Currency), проверка обязательных полей и бизнес-правил, подсветка ошибок.
- **Справочники** — Счета, Категории (и подкатегории). Валидация по ним в ячейках (выпадающие списки).
- **Автокатегоризация** — правила в листе «Правила категоризации» (паттерн по Merchant/Description → Category/Subcategory). Применяется при импорте и из меню «Применить автокатегоризацию».
- **Дедупликация** — по (Source, SourceId); при совпадении с уже существующей транзакцией новая не дублируется (или помечается needs_review при особых сценариях в raw).
- **Статусы** — ok, needs_review, duplicate, deleted — для отбора «чистых» данных в отчётах и дашборде.

**Итог по цели 2:** Данные приводятся к единому формату, проверяются и обогащаются категориями. Подготовка для анализа в целом есть; ниже отмечены точечные улучшения.

---

### 2.3. Дашборды и отчёты

**Реализовано:**

- **Лист «Отчёты»** — сводка по периодам (текущий месяц, текущий год), сравнение с предыдущим месяцем (изменение и %), средние значения (средний расход в день, в месяц за 3/6/12 месяцев), простой прогноз на следующий месяц, топ категорий расходов, месячный cashflow (12 месяцев), остатки по счетам (с учётом начального баланса и переводов), блок бюджетов (план/факт/остаток/статус).
- **Лист «Дашборд»** (обновляется по кнопке «Обновить дашборд»):
  - KPI текущего месяца: доходы, расходы, итого, средний расход в день;
  - показатели бюджетов: количество превышенных, средний % использования; список превышенных бюджетов;
  - круговая диаграмма «Расходы по категориям» (текущий месяц, топ-10);
  - линейный график «Динамика доходов и расходов» (12 месяцев);
  - столбчатая диаграмма «Сравнение месяцев» (текущий vs предыдущий);
  - столбчатая диаграмма «Средние расходы по дням недели» (текущий месяц).
- **Локализация** — RU/EN для листов, заголовков и меню.

**Итог по цели 3:** Дашборд и отчёты покрывают основные показатели и визуализации для личных финансов. Есть KPI, бюджеты, категории, тренды и сравнение периодов.

---

## 3. Соответствие целям и замечания

### 3.1. Цель 1: сбор данных с разных счетов

| Аспект | Оценка | Замечания |
|--------|--------|-----------|
| Несколько счетов | ✅ | Raw-листы по одному на счёт, импорт из файлов банков, ручной ввод с выбором счёта |
| Единое хранилище | ✅ | Всё в листе «Транзакции» |
| Дедупликация | ✅ | По Source + SourceId; в raw — учёт номера строки в SourceId |
| Формат raw-листов | ⚠️ | Жёстко задан (7 колонок в фиксированном порядке). Другие форматы выписок не поддерживаются без доработки |
| Документация для пользователя | ⚠️ | В Help описан общий поток; пошаговой «как добавить новый счёт / новый raw-лист» может не хватать |

**Рекомендации:**

- Опционально: лист **Raw_Config** (или аналог) для маппинга колонок разных форматов raw → каноническая схема (см. `docs/RAW_SHEETS_ARCHITECTURE.md`, п. 3.3).
- В инструкцию добавить раздел: «Как добавить новый счёт (новый raw-лист)» с примером заголовков и одного-двух строк.

---

### 3.2. Цель 2: подготовка данных для анализа

| Аспект | Оценка | Замечания |
|--------|--------|-----------|
| Единый формат | ✅ | Одна схема транзакций, одна валюта по умолчанию в настройках |
| Категоризация | ✅ | Справочник + автоправила по описанию/мерчанту |
| Качество данных | ✅ | Валидация, статусы, пометка «на проверку», поиск дубликатов по ключу |
| Мультивалютность | ❌ | Поле «Валюта» есть, но курсов нет; пересчёт в базовую валюту в отчётах не реализован |
| Аудит изменений | ⚠️ | Нет полей CreatedAt/UpdatedAt; при необходимости — добавить в схему позже |
| Уникальный Id транзакции | ⚠️ | Нет внутреннего Id; для ручных строк идентификация по позиции/хэшу. Для продвинутых сценариев (восстановление, связки) полезен Id |

**Рекомендации:**

- Мультивалютность: лист **Курсы валют** (дата, валюта, курс к базовой), пересчёт в отчётах и дашборде в базовую валюту (см. TECHNICAL_SPECIFICATION.md, Этап 4).
- При росте требований: добавить в схему транзакций поля Id, CreatedAt, UpdatedAt (опционально, с обратной совместимостью).

---

### 3.3. Цель 3: дашборды и наглядность

| Аспект | Оценка | Замечания |
|--------|--------|-----------|
| KPI текущего месяца | ✅ | Доходы, расходы, итого, средний расход в день |
| Бюджеты на дашборде | ✅ | Превышенные бюджеты, средний % использования |
| Графики | ✅ | Круг по категориям, линия по месяцам, сравнение месяцев, по дням недели |
| Сравнение периодов | ✅ | В отчётах и на дашборде (текущий vs предыдущий месяц) |
| Прогноз | ✅ | Простой прогноз в отчётах (среднее за 3 месяца) |
| Обновление | ⚠️ | Дашборд обновляется по кнопке; при большом объёме данных возможна задержка |
| Выбор периода на дашборде | ⚠️ | Период зашит (текущий месяц/год, последние 12 месяцев). Выбора «показать за выбранный месяц» нет |
| Остатки по счетам на дашборде | ⚠️ | В отчётах есть; на дашборде отдельным блоком не вынесены |

**Рекомендации:**

- Опционально: на дашборде блок «Остатки по счетам» (кратко: счёт — сумма), с переходом в отчёты для детализации.
- Долгосрочно: возможность выбора месяца/квартала для дашборда (например, через выпадающий список или отдельный лист «Параметры дашборда»).

---

## 4. Дополнительные замечания по прототипу

### 4.1. Архитектура и код

- **Архитектура raw → Транзакции** описана в `docs/RAW_SHEETS_ARCHITECTURE.md`, реализация в `src/RawSheets.js` ей соответствует.
- **Константы и обработка ошибок** вынесены в Constants.js и ErrorHandler.js; дублирование логики дедупликации устранено.
- **Запись при синхронизации raw** в RawSheets.js идёт чанками по 500 строк; для очень больших объёмов стоит проверить лимиты выполнения и при необходимости уменьшить размер чанка или добавить паузы.

### 4.2. Логика синхронизации raw

- При совпадении ключа с уже существующей транзакцией в «Транзакции» текущая реализация всё равно добавляет строку со статусом `needs_review` и пометкой в описании/тегах. Итог: в листе появляются две строки (старая и «возможный дубликат»). **Рекомендация:** при совпадении ключа не добавлять новую строку, а только сообщать пользователю «пропущено N как дубликаты»; при необходимости дать опцию «всё равно добавить как needs_review» отдельным действием.
- В коде (RawSheets.js) при `alreadyOnSheet` строка всё равно пушится в `allNewRows` с `status: 'needs_review'`. Это и создаёт дубликаты в таблице. Исправление: не добавлять такие строки в `allNewRows`, а только увеличивать `result.skipped`.

### 4.3. Форматирование после записи (RawSheets.js)

- Для даты и суммы вызывается `setNumberFormat` с диапазоном; для колонки даты передаётся `numRows` как третий аргумент. В API Google Sheets `getRange(row, column, numRows, numColumns)` — третий аргумент это число строк. Нужно убедиться, что записанный диапазон именно от `startRow` на `numRows` строк (т.е. последняя строка `startRow + numRows - 1`). Сейчас вызов выглядит как `getRange(startRow, dateCol, numRows, 1)` — то есть один столбец `dateCol`, что верно. Проверить при тестах, что формат применяется ко всем новым строкам, а не только к первому чанку.

### 4.4. Производительность

- Отчёты и дашборд считают данные скриптом (без тяжёлых QUERY по всему листу), что уменьшает риск #N/A и тормозов.
- При >10 000 транзакций имеет смысл рекомендовать архивирование старых данных (уже есть: «Архивировать старые транзакции»).

### 4.5. Безопасность и резервные копии

- Реализованы: экспорт транзакций (CSV/JSON), экспорт всех данных (JSON), создание резервной копии листа «Транзакции». Пользователю стоит явно рекомендовать периодические бэкапы и использование истории версий Google Таблиц.

---

## 5. План переработки и развития (для передачи на реализацию)

Ниже — приоритизированный список задач. Критичные для целей «сбор + подготовка + дашборды» уже в основном закрыты; пункты помечены по влиянию на цели и UX.

### 5.1. Критичные исправления

| № | Задача | Где | Описание |
|---|--------|-----|----------|
| 1 | Не добавлять дубликаты с raw в лист «Транзакции» | RawSheets.js | **ИСПРАВЛЕНО (31.01.2026):** при совпадении (Source, SourceId) с существующей транзакцией строка не добавляется в allNewRows; только result.skipped++ и continue. |
| 2 | Проверка форматирования новых строк при синхронизации raw | RawSheets.js | Убедиться, что setNumberFormat применяется ко всем добавленным строкам (все чанки), а не только к первому диапазону. При батчевой записи — один общий диапазон от startRow на numRows строк по каждой колонке (дата, сумма, SourceId как текст). |

### 5.2. Важные доработки (цели 1–3)

| № | Задача | Описание |
|---|--------|----------|
| 3 | Мультивалютность | Лист «Курсы валют» (дата, валюта, курс к базовой). В отчётах и дашборде: пересчёт сумм в базовую валюту по курсу на дату транзакции; KPI и графики в базовой валюте. См. TECHNICAL_SPECIFICATION.md, Этап 4. |
| 4 | Документация для пользователя | В Help: раздел «Как добавить новый счёт (raw-лист)»: требования к имени листа, пример заголовков и 1–2 строк данных, порядок действий (создать лист → заполнить → Синхронизировать с raw-листами). |
| 5 | Опциональный маппинг форматов raw | Лист Raw_Config (или аналог) для приведения других форматов выписок к каноническим полям (см. RAW_SHEETS_ARCHITECTURE.md, п. 3.3). Реализовать после фиксации спроса на второй формат raw. |

### 5.3. Улучшения аналитики и дашборда

| № | Задача | Описание |
|---|--------|----------|
| 6 | Остатки по счетам на дашборде | Блок «Остатки по счетам» на листе Дашборд (счёт — сумма), данные из той же логики, что в отчётах (начальный баланс + транзакции + переводы). |
| 7 | Выбор периода для дашборда (опционально) | Параметр «месяц/квартал» (например, в настройках или на листе «Параметры») и пересчёт KPI/графиков за выбранный период. Требует изменения формул/скрипта дашборда. |

### 5.4. Качество данных и схема

| № | Задача | Описание |
|---|--------|----------|
| 8 | Id и аудит (опционально) | Добавить в схему транзакций колонки Id (уникальный идентификатор), CreatedAt, UpdatedAt. Заполнять при создании/обновлении; миграция существующих строк — по возможности без потери данных. |
| 9 | Единый ключ дедупликации | Убедиться, что импорт (CSV/PDF) и raw используют одну и ту же функцию/правила формирования ключа там, где это применимо, чтобы не было расхождений между «дубликат из файла» и «дубликат из raw». |

### 5.5. Тестирование и стабильность

| № | Задача | Описание |
|---|--------|----------|
| 10 | Тесты для RawSheets | Юнит-тесты: парсинг даты/суммы/времени, формирование SourceId, дедупликация (не добавлять строку при уже существующем ключе). |
| 11 | Ручной сценарий «новый пользователь» | Пошаговая проверка: Setup → создание raw-листа → синхронизация → проверка отчётов и дашборда. Зафиксировать в TESTING_CHECKLIST или аналоге. |

---

## 6. Итоговая сводка

### 6.1. Соответствие целям

| Цель | Статус | Комментарий |
|------|--------|-------------|
| 1. Сбор данных с разных счетов | ✅ Выполнено | Raw-листы, импорт файлов, ручной ввод; единый лист «Транзакции»; дедупликация. Исправить: не добавлять дубликаты с raw в таблицу (п. 5.1). |
| 2. Подготовка данных для анализа | ✅ В основном выполнено | Нормализация, категории, валидация, автокатегоризация. Доработать: мультивалютность (курсы и пересчёт). |
| 3. Информативные дашборды | ✅ Выполнено | KPI, бюджеты, несколько графиков, сравнение периодов, прогноз. Улучшение: остатки по счетам на дашборде, опционально — выбор периода. |

### 6.2. Приоритеты для реализации

1. **Сначала:** п. 5.1 (исправление логики дубликатов и форматирования в RawSheets).
2. **Далее:** п. 5.2 (мультивалютность при необходимости, документация, при потребности — Raw_Config).
3. **Затем:** п. 5.3–5.5 по важности для продукта и доступным ресурсам.

### 6.3. Ссылки на документы в репозитории

- Архитектура raw-листов: `docs/RAW_SHEETS_ARCHITECTURE.md`
- Схема транзакций: `docs/TRANSACTIONS_SCHEMA.md`
- Техническое задание (этапы 1–10): `docs/TECHNICAL_SPECIFICATION.md`
- Экспертная оценка: `docs/EXPERT_REVIEW.md`
- Текущее состояние проекта: `docs/PROJECT_STATE.md`
- Код: `src/RawSheets.js`, `src/Code.js`, `src/Dashboard.js`, `src/Reports.js`, `src/Import.js`, `src/Schema.js`.

---

Документ готов к передаче команде разработки для планирования спринтов и реализации доработок.

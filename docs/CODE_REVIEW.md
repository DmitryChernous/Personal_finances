# Архитектурный ревью проекта Personal Finances

**Дата:** 2026-01-25  
**Проект:** Personal Finances (Google Sheets + Apps Script)  
**Статус:** Полный архитектурный анализ  
**Последнее обновление:** 2026-01-25 (исправления применены)

---

## Оглавление

1. [Критические проблемы](#критические-проблемы)
2. [Архитектурные проблемы](#архитектурные-проблемы)
3. [Мертвый код](#мертвый-код)
4. [Дублирование кода](#дублирование-кода)
5. [Проблемы производительности](#проблемы-производительности)
6. [Проблемы надежности](#проблемы-надежности)
7. [Проблемы безопасности](#проблемы-безопасности)
8. [Проблемы с документацией](#проблемы-с-документацией)
9. [Лишние файлы](#лишние-файлы)
10. [Рекомендации по улучшению](#рекомендации-по-улучшению)

---

## Критические проблемы

### 1. Мертвый код: `pfProcessFileImport_()` не используется ✅ УДАЛЕНО

**Местоположение:** ранее `src/Import.js`

**Проблема:**
Функция `pfProcessFileImport_()` была определена, но нигде не вызывалась. Вся логика импорта переписана на использование публичных функций (`pfDetectFileFormat`, `pfParseFileContent`, `pfProcessDataBatch`, `pfWritePreview`), которые вызываются из клиентского кода в `ImportUI.html`.

**Решение:** ✅
- Функция удалена в рамках рефакторинга (DEVELOPER_TASKS, задача 3)

**Приоритет:** Средний (не влияет на работу, но засоряет код)

---

### 2. Мертвый код: `pfProcessImportData_()` не используется ✅ УДАЛЕНО

**Местоположение:** ранее `src/Import.js`

**Проблема:**
Функция `pfProcessImportData_()` была определена, но не вызывалась нигде в коде. Вся обработка данных происходит в `pfProcessDataBatch()`.

**Решение:** ✅
- Функция удалена в рамках рефакторинга (DEVELOPER_TASKS, задача 3)

**Приоритет:** Средний

---

### 3. Хардкод строки в меню (нарушение i18n) ✅ ИСПРАВЛЕНО

**Местоположение:** `src/Code.js:17`

**Проблема:**
```javascript
menu.addItem('Найти дубликат (по ключу)', 'pfFindDuplicateByKey');
```

Строка захардкожена на русском языке, хотя в проекте есть система i18n. Это нарушает принцип локализации.

**Решение:** ✅
- Добавлен ключ `find_duplicate` в `src/I18n.js` (RU и EN)
- Заменено на `pfT_('menu.find_duplicate')` в меню
- Теперь поддерживается локализация

**Приоритет:** Низкий (функциональность работает, но нарушает архитектуру)

---

## Архитектурные проблемы

### 4. Избыточное логирование в production коде ✅ ИСПРАВЛЕНО

**Местоположение:** Множественные файлы, особенно `src/Import.js` (было 120+ вызовов `Logger.log`)

**Проблема:**
В коде очень много логирования, которое было добавлено для отладки. В production это:
- Замедляет выполнение
- Засоряет логи Apps Script
- Увеличивает размер кода

**Решение:** ✅
- Создан модуль `ErrorHandler.js` с системой уровней логирования (DEBUG, INFO, WARNING, ERROR)
- Текущий уровень: WARNING (только ERROR и WARNING логируются)
- Заменены все `Logger.log` на `pfLogError_`, `pfLogWarning_`, `pfLogInfo_`, `pfLogDebug_`
- Удалены избыточные DEBUG логи из `src/Import.js` (осталось ~43 вызова, в основном ERROR/WARNING)
- Логирование теперь централизовано и управляемо

**Приоритет:** Средний

---

### 5. Дублирование логики генерации ключей дедупликации ✅ ИСПРАВЛЕНО

**Местоположение:** 
- `src/Import.js:pfGenerateDedupeKey_()` (строки 85-150)
- `src/Import.js:pfFindDuplicateTransaction()` (строки 540-575)
- `src/Import.js:pfGetExistingTransactionKeys_()` (строки 370-390)

**Проблема:**
Логика генерации ключей дедупликации дублировалась в трех местах с небольшими вариациями. Это приводило к:
- Сложности поддержки (нужно обновлять в трех местах)
- Риску рассинхронизации логики
- Потенциальным багам (как уже было с дедупликацией)

**Решение:** ✅
- Создана единая функция `pfGenerateDedupeKey_(data, options)` которая работает и с TransactionDTO, и с sheet rows
- Все три места теперь используют эту единую функцию
- Логика централизована, что устраняет риск рассинхронизации

**Приоритет:** Высокий (уже привело к багам)

---

### 6. Отсутствие централизованной обработки ошибок

**Местоположение:** Весь проект

**Проблема:**
Обработка ошибок разбросана по коду, нет единого подхода:
- Где-то используется `try-catch` с логированием
- Где-то ошибки пробрасываются наверх
- Где-то возвращаются объекты с `success: false`
- Нет единого формата ошибок

**Решение:**
- Создать модуль `ErrorHandler.js` с функциями:
  - `pfHandleError_(error, context)` - централизованная обработка
  - `pfCreateErrorResponse_(message, code)` - единый формат ошибок
  - `pfLogError_(error, context, level)` - единое логирование ошибок

**Приоритет:** Средний

---

### 7. Смешение ответственности в модулях ✅ ЧАСТИЧНО ИСПРАВЛЕНО

**Местоположение:** 
- `src/Setup.js` - содержал логику Help (строки 347-505) ✅ ИСПРАВЛЕНО
- `src/Import.js` - содержит слишком много ответственности (DTO, импорт, дедупликация, preview, commit) ⚠️ ОТЛОЖЕНО

**Проблема:**
Модули делают слишком много разных вещей, что усложняет поддержку и тестирование.

**Решение:** ✅
- ✅ Вынести Help content в отдельный модуль `Help.js` - ВЫПОЛНЕНО
- ⚠️ Разбить `Import.js` на подмодули - ОТЛОЖЕНО (большая задача, требует тщательного планирования)
  - `Import/Core.js` - базовая логика
  - `Import/Deduplication.js` - дедупликация
  - `Import/Preview.js` - preview функциональность
  - `Import/Commit.js` - commit функциональность

**Приоритет:** Низкий (рефакторинг для улучшения архитектуры)

---

### 8. Магические числа и строки ✅ ИСПРАВЛЕНО

**Местоположение:** Весь проект

**Проблема:**
В коде много магических чисел и строк без констант:
- `batchSize = 200` в нескольких местах
- `'ok'`, `'duplicate'`, `'needs_review'` - статусы транзакций
- `'expense'`, `'income'`, `'transfer'` - типы транзакций
- `'import:csv'`, `'import:sberbank'` - источники

**Решение:** ✅
- Создан модуль `Constants.js` с константами:
  - `PF_TRANSACTION_STATUS` (OK, DUPLICATE, NEEDS_REVIEW, DELETED)
  - `PF_TRANSACTION_TYPE` (EXPENSE, INCOME, TRANSFER)
  - `PF_IMPORT_SOURCE` (MANUAL, CSV, SBERBANK, ERROR)
  - `PF_IMPORT_BATCH_SIZE = 200`
  - `PF_IMPORT_MAX_FILE_SIZE`, `PF_IMPORT_MAX_TRANSACTIONS`
  - `PF_DEFAULT_CURRENCY`, `PF_SUPPORTED_CURRENCIES`
- Все магические значения заменены на константы во всех файлах
- Улучшена поддерживаемость и снижен риск опечаток

**Приоритет:** Средний

---

## Мертвый код

### 9. Неиспользуемые функции ✅ УДАЛЕНО

**Было:**
1. `pfProcessFileImport_()` — ранее в `src/Import.js`
2. `pfProcessImportData_()` — ранее в `src/Import.js`

**Решение:** ✅
- Обе функции удалены в рамках рефакторинга (DEVELOPER_TASKS, задача 3)

**Приоритет:** Низкий

---

## Дублирование кода

### 10. Дублирование логики очистки sheet ✅ ИСПРАВЛЕНО

**Местоположение:**
- `src/Import.js:pfPreviewImport_()` (было строки 391-407)
- `src/Import.js:pfCommitImport_()` (было строки 791-809)
- `src/Template.js:pfPrepareTemplate_()` (было множественные места)

**Проблема:**
Логика безопасной очистки sheet (clearContent, clearFormat, clearNote, deleteRows с fallback) дублировалась в трех местах.

**Решение:** ✅
- Создана функция `pfClearSheetRows_(sheet, startRow, numRows)` в `src/Sheets.js`
- Заменены все дублирующиеся места (7 мест) на вызов единой функции
- Улучшена поддерживаемость и консистентность

**Приоритет:** Средний

---

### 11. Дублирование логики создания демо-данных

**Местоположение:**
- `src/Template.js:pfResetDemoAccounts_()` и `pfCreateDemoAccounts_()`
- `src/Template.js:pfResetDemoCategories_()` и `pfCreateDemoCategories_()`
- `src/TestData.js` - похожая логика

**Проблема:**
Логика создания демо-данных дублируется между Template и TestData.

**Решение:**
- Вынести в общий модуль `DemoData.js`
- Использовать в обоих местах

**Приоритет:** Низкий

---

### 12. Дублирование логики конвертации Date в ISO строку

**Местоположение:**
- `src/Import.js:pfProcessDataBatch()` (строка 1061)
- `src/Import.js:pfTransactionDTOToRow_()` (обратная конвертация)

**Проблема:**
Логика конвертации Date ↔ ISO string разбросана по коду.

**Решение:**
- Создать утилиты:
  - `pfDateToISOString_(date)` 
  - `pfISOStringToDate_(isoString)`
- Использовать везде

**Приоритет:** Низкий

---

## Проблемы производительности

### 13. Избыточное логирование замедляет выполнение

**Местоположение:** Весь проект, особенно `src/Import.js`

**Проблема:**
120+ вызовов `Logger.log` в одном файле замедляют выполнение, особенно при обработке больших файлов.

**Решение:**
- Удалить DEBUG логи
- Оставить только ERROR и WARNING
- Использовать условное логирование

**Приоритет:** Средний

---

### 14. Множественные обращения к sheet.getLastRow()

**Местоположение:** Множественные файлы

**Проблема:**
`sheet.getLastRow()` вызывается многократно в циклах, хотя значение не меняется.

**Решение:**
- Кэшировать значение `lastRow` в переменную перед циклом

**Приоритет:** Низкий

---

## Проблемы надежности

### 15. Отсутствие валидации входных данных в публичных функциях ✅ ИСПРАВЛЕНО

**Местоположение:** 
- `src/Import.js:pfCommitImport()` - было нет проверки типов
- `src/Template.js:pfCreateTemplate()` - было нет проверки состояния таблицы
- `src/Import.js:pfDetectFileFormat()`, `pfParseFileContent()`, `pfWritePreview()`, `pfFindDuplicateTransaction()`, `pfProcessDataBatch()`

**Проблема:**
Публичные функции не всегда валидировали входные данные, что могло привести к ошибкам.

**Решение:** ✅
- Добавлена валидация входных данных во все публичные функции:
  - Проверка типов (string, number, boolean, object, array)
  - Проверка на пустоту (empty strings, null, undefined)
  - Проверка диапазонов (batchSize, file size, transaction count)
  - Проверка форматов (JSON, dedupe key format)
  - Проверка доступа к таблице
- Все валидации используют ErrorHandler для единообразного логирования
- Используются константы из Constants.js для лимитов

**Приоритет:** Средний

---

### 16. Отсутствие обработки edge cases

**Местоположение:** Весь проект

**Проблема:**
Не все edge cases обработаны:
- Пустые sheets
- Sheets с только заголовками
- Очень большие файлы
- Одновременные изменения данных

**Решение:**
- Добавить проверки для всех edge cases
- Добавить graceful degradation

**Приоритет:** Средний

---

## Проблемы безопасности

### 17. Отсутствие валидации размера файлов

**Местоположение:** `src/Import.js:pfParseFileContent()`

**Проблема:**
Есть проверка на 50MB, но нет проверки на количество строк, что может привести к таймаутам.

**Решение:**
- Добавить проверку на максимальное количество строк (например, 10000)
- Добавить предупреждение при больших файлах

**Приоритет:** Низкий

---

### 18. Отсутствие санитизации пользовательского ввода

**Местоположение:** 
- `src/Code.js:pfFindDuplicateByKey()` - пользовательский ввод напрямую используется

**Проблема:**
Пользовательский ввод не санитизируется перед использованием.

**Решение:**
- Добавить санитизацию строк (trim, escape)
- Валидировать формат ключей дедупликации

**Приоритет:** Низкий (в контексте Apps Script риск минимален)

---

## Проблемы с документацией

### 19. Устаревшие документы

**Местоположение:**
- `ARCHITECTURE_REVIEW.md` - содержит устаревшую информацию о проблемах, которые уже исправлены
- `PROBLEM_LOCATION.md` - описывает проблему, которая уже решена

**Проблема:**
Документы не обновляются после исправления проблем, что может вводить в заблуждение.

**Решение:**
- Обновить или удалить устаревшие документы
- Добавить дату последнего обновления
- Пометить как "Исправлено" или удалить

**Приоритет:** Низкий

---

### 20. Избыточное количество документационных файлов

**Местоположение:** Корень проекта

**Проблема:**
12 файлов .md в корне проекта:
- `ARCHITECTURE_REVIEW.md` - устаревший
- `PROBLEM_LOCATION.md` - устаревший
- `SESSION_SUMMARY.md` - временный
- `QUICK_TEST_STAGE3.md` - временный
- `TEST_STAGE3_4_IMPROVED.md` - временный
- `TESTING_CHECKLIST.md` - может быть объединен с другими

**Решение:**
- Создать папку `docs/` для документации
- Переместить туда все .md файлы кроме `README.md`
- Удалить или архивировать устаревшие документы
- Объединить похожие документы

**Приоритет:** Низкий

---

## Лишние файлы

### 21. Временные тестовые файлы в репозитории

**Местоположение:** Корень проекта

**Проблема:**
- `Сбер Карта.csv` - персональные данные банковской выписки
- `Сбер Карта.pdf` - персональные данные банковской выписки

**Решение:**
- Удалить из репозитория (они уже в .gitignore, но могут быть в истории)
- Создать примеры файлов с анонимизированными данными для тестирования
- Добавить в `.gitignore` если еще не добавлены

**Приоритет:** Высокий (безопасность персональных данных)

---

### 22. package.json содержит неиспользуемые поля

**Местоположение:** `package.json`

**Проблема:**
- `"main": "index.js"` - файл не существует
- `"type": "commonjs"` - не используется в Apps Script

**Решение:**
- Удалить неиспользуемые поля или оставить для совместимости

**Приоритет:** Очень низкий

---

## Рекомендации по улучшению

### 23. Создать модуль констант

**Приоритет:** Средний

Создать `src/Constants.js` с:
- Статусы транзакций
- Типы транзакций
- Источники данных
- Размеры батчей
- Лимиты

---

### 24. Создать модуль утилит для работы с датами

**Приоритет:** Низкий

Создать `src/DateUtils.js` с:
- Конвертация Date ↔ ISO string
- Форматирование дат
- Парсинг дат из разных форматов

---

### 25. Добавить unit-тесты (опционально)

**Приоритет:** Низкий

Для критичных функций (дедупликация, парсинг) можно добавить unit-тесты через Google Apps Script тестовый фреймворк.

---

### 26. Создать модуль для работы с ошибками

**Приоритет:** Средний

Создать `src/ErrorHandler.js` с централизованной обработкой ошибок.

---

### 27. Рефакторинг Import.js

**Приоритет:** Низкий

Разбить большой файл `Import.js` (1310+ строк) на модули:
- `Import/Core.js`
- `Import/Deduplication.js`
- `Import/Preview.js`
- `Import/Commit.js`

---

## Приоритизация исправлений

### Критично (сделать немедленно):
1. **#21** - Удалить персональные данные из репозитория

### Высокий приоритет:
2. **#5** - Устранить дублирование логики дедупликации (уже привело к багам)

### Средний приоритет:
3. **#4** - Убрать избыточное логирование
4. **#6** - Централизовать обработку ошибок
5. **#8** - Вынести магические значения в константы
6. **#10** - Устранить дублирование логики очистки sheet
7. **#15** - Добавить валидацию входных данных

### Низкий приоритет:
8. **#1, #2** - Удалить мертвый код
9. **#3** - Исправить хардкод в меню
10. **#7** - Рефакторинг модулей
11. **#11, #12** - Устранить дублирование
12. **#13, #14** - Оптимизация производительности
13. **#16, #17, #18** - Улучшение надежности и безопасности
14. **#19, #20** - Упорядочить документацию
15. **#22** - Почистить package.json

---

## Итоговая оценка

**Общее состояние проекта:** Хорошее

**Сильные стороны:**
- Четкая структура модулей
- Хорошая система i18n
- Идемпотентный setup
- Работающая функциональность

**Основные проблемы:**
- Избыточное логирование
- Дублирование кода (особенно дедупликация)
- Мертвый код
- Недостаточная централизация обработки ошибок

**Рекомендация:** Начать с критичных и высокоприоритетных задач, затем постепенно улучшать архитектуру.

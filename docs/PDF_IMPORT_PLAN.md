# План реализации импорта PDF файлов

## Оценка готовности архитектуры

### ✅ Архитектура полностью готова

**Текущая система импорта:**
- ✅ Интерфейс `PF_IMPORTER_INTERFACE` с методами: `detect`, `parse`, `normalize`, `dedupeKey`
- ✅ Модульная система импортеров (`PF_SBERBANK_IMPORTER`, `PF_CSV_IMPORTER`)
- ✅ Унифицированные функции: `pfDetectFileFormat`, `pfParseFileContent`, `pfProcessDataBatch`
- ✅ UI готов (`ImportUI.html`) - поддерживает загрузку файлов
- ✅ Preview и Commit workflow
- ✅ Дедупликация и обработка ошибок

**Что нужно добавить:**
- Новый импортер `PF_PDF_IMPORTER` по тому же паттерну
- Парсеры для конкретных банков (модульная система)
- Интеграция с Google Drive API для извлечения текста из PDF

### ❌ Не нужно переписывать код

Архитектура спроектирована так, что новый импортер просто добавляется в систему без изменения существующего кода.

---

## План реализации

### Этап 1: Базовая инфраструктура PDF импорта (2-3 часа)

**Задачи:**
1. Создать модуль `src/ImportPdf.js` с базовым импортером
2. Реализовать извлечение текста из PDF через Google Drive API
3. Добавить поддержку PDF в UI (`ImportUI.html`)
4. Обновить `pfDetectFileFormat` для распознавания PDF

**Технические детали:**
```javascript
// Базовый PDF импортер
var PF_PDF_IMPORTER = {
  detect: function(data, fileName) {
    // Проверка расширения .pdf или MIME type
  },
  
  parse: function(data, options) {
    // 1. Загрузить PDF в Google Drive (если это Blob)
    // 2. Извлечь текст через Drive API с OCR
    // 3. Определить банк по тексту
    // 4. Вызвать соответствующий парсер банка
  },
  
  normalize: function(rawTransaction, options) {
    // Нормализация в TransactionDTO
  },
  
  dedupeKey: function(transaction) {
    // Генерация ключа дедупликации
  }
};
```

**Требования:**
- Включить Advanced Drive API в `appsscript.json`
- Добавить обработку Blob файлов в UI

---

### Этап 2: Парсер для Сбербанка PDF (3-4 часа)

**Задачи:**
1. Создать модуль `src/ImportPdfSberbank.js`
2. Реализовать парсинг текста выписки Сбербанка
3. Распознавание структуры:
   - Заголовок с информацией о счете
   - Таблица транзакций
   - Итоговые суммы

**Структура парсера:**
```javascript
var PF_PDF_SBERBANK_PARSER = {
  detect: function(text) {
    // Проверка маркеров Сбербанка в тексте
  },
  
  parse: function(text) {
    // Парсинг через регулярные выражения
    // Извлечение: дата, сумма, описание, контрагент
  }
};
```

**Сложность:**
- Средняя - нужно протестировать на реальных выписках
- Формат может варьироваться, нужна гибкость

---

### Этап 3: Парсер для Тинькофф PDF (3-4 часа)

**Задачи:**
1. Создать модуль `src/ImportPdfTinkoff.js`
2. Реализовать парсинг выписок Тинькофф
3. Аналогично Сбербанку, но с учетом особенностей формата

---

### Этап 4: Улучшения и оптимизация (2-3 часа)

**Задачи:**
1. Кэширование извлеченного текста (чтобы не обрабатывать PDF повторно)
2. Обработка многостраничных PDF
3. Улучшенная обработка ошибок парсинга
4. Поддержка сканированных PDF через OCR

**OCR через Google Drive API:**
```javascript
// Пример извлечения текста с OCR
var file = DriveApp.getFileById(fileId);
var resource = {
  title: file.getName(),
  mimeType: 'application/pdf'
};
var blob = file.getBlob();
var options = {
  ocr: true,
  ocrLanguage: 'ru'
};
var doc = Drive.Files.insert(resource, blob, options);
var text = DocumentApp.openById(doc.id).getBody().getText();
```

---

## Оценка сложности

### Общая оценка: 10-14 часов

**Разбивка:**
- Этап 1 (Базовая инфраструктура): 2-3 часа
- Этап 2 (Сбербанк): 3-4 часа
- Этап 3 (Тинькофф): 3-4 часа
- Этап 4 (Улучшения): 2-3 часа

### Основные вызовы:

1. **Парсинг текста** - самая сложная часть
   - Разные форматы у разных банков
   - Нужно тестирование на реальных выписках
   - Решение: модульная система парсеров для каждого банка

2. **OCR для сканированных PDF**
   - Google Drive API поддерживает OCR
   - Может быть медленным для больших файлов
   - Решение: кэширование и прогресс-индикатор

3. **Обработка многостраничных PDF**
   - Нужно объединять данные со всех страниц
   - Решение: парсинг всего текста сразу

---

## Преимущества текущей архитектуры

### ✅ Модульность
- Каждый банк - отдельный парсер
- Легко добавлять новые банки
- Не нужно менять существующий код

### ✅ Единый интерфейс
- Все импортеры работают одинаково
- UI автоматически поддерживает новые форматы
- Preview и Commit workflow работают из коробки

### ✅ Обработка ошибок
- Существующая система пометки на проверку
- Валидация транзакций
- Дедупликация

---

## Рекомендации по реализации

### Подход 1: Поэтапная реализация (рекомендуется)

1. **Начать с одного банка** (например, Сбербанк)
2. **Протестировать на реальных выписках**
3. **Добавлять другие банки по мере необходимости**

### Подход 2: Универсальный парсер

- Сложнее в реализации
- Менее надежный
- Требует больше тестирования

**Рекомендация:** Использовать Подход 1

---

## Технические требования

### Необходимые изменения в `appsscript.json`:

```json
{
  "timeZone": "Europe/Moscow",
  "dependencies": {},
  "exceptionLogging": "STACKDRIVER",
  "runtimeVersion": "V8",
  "oauthScopes": [
    "https://www.googleapis.com/auth/spreadsheets",
    "https://www.googleapis.com/auth/drive",
    "https://www.googleapis.com/auth/drive.file"
  ]
}
```

### Включить Advanced Drive API:
- В редакторе Apps Script: Resources → Advanced Google Services
- Включить "Drive API"

---

## Пример использования

После реализации пользователь сможет:

1. Открыть меню "Импорт транзакций"
2. Выбрать PDF файл (вместо CSV)
3. Система автоматически:
   - Определит банк по содержимому
   - Извлечет текст (с OCR если нужно)
   - Распарсит транзакции
   - Покажет preview
4. Пользователь подтверждает импорт

---

## Заключение

**Архитектура полностью готова** для реализации PDF импорта. Не нужно переписывать существующий код - достаточно добавить новый импортер по тому же паттерну.

**Сложность:** Средняя (10-14 часов)
**Риски:** Низкие (модульная архитектура, можно тестировать по частям)
**Преимущества:** Значительное улучшение UX для пользователей

**Рекомендация:** Начать с реализации для одного банка (Сбербанк), протестировать, затем добавлять другие банки.

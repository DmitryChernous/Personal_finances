# Отладка проблемы с обновлением бюджетов

## Проблема
Кнопка "Обновить бюджеты" не заполняет расчетные поля (Факт, Остаток, Статус, % использования).

## Шаги для отладки

### 1. Проверьте логи в Apps Script
1. Откройте Apps Script редактор (Расширения → Apps Script)
2. Выберите View → Logs
3. Запустите: Personal finances → Обновить бюджеты
4. Проверьте логи - должны быть сообщения DEBUG уровня

### 2. Проверьте данные в листе Budgets
Убедитесь, что данные введены правильно:
- **Категория** должна точно совпадать с категориями из листа "Категории"
- **Период** должен быть: `month` или `year` (точно так, без кавычек)
- **Значение периода** должно быть:
  - Для месяца: `2026-01` (формат YYYY-MM)
  - Для года: `2026` (формат YYYY)
- **Сумма** должна быть числом > 0

### 3. Важно: Соответствие категорий
В тестовых данных категории называются так:
- **"Еда"** (с подкатегориями "Продукты" и "Рестораны")
- **"Транспорт"** (с подкатегориями "Общественный" и "Бензин")
- **"Одежда"** (без подкатегории)
- **"Жильё"** (с подкатегорией "Коммунальные")
- и т.д.

**НЕ существует категории "Продукты"** - это подкатегория категории "Еда"!

### 4. Правильные примеры бюджетов

#### Пример 1: Бюджет на категорию "Еда" (все подкатегории)
- Категория: **Еда**
- Подкатегория: (пусто)
- Период: month
- Значение периода: 2026-01
- Сумма: 10000

#### Пример 2: Бюджет на подкатегорию "Продукты"
- Категория: **Еда**
- Подкатегория: **Продукты**
- Период: month
- Значение периода: 2026-01
- Сумма: 5000

#### Пример 3: Бюджет на категорию "Одежда"
- Категория: **Одежда**
- Подкатегория: (пусто)
- Период: month
- Значение периода: 2026-01
- Сумма: 3000

### 5. Проверьте транзакции
1. Откройте лист "Транзакции"
2. Убедитесь, что есть транзакции:
   - С категорией, которая указана в бюджете
   - За период, указанный в бюджете (например, январь 2026)
   - Со статусом "ok"
   - Тип "expense" или "income"

### 6. Что проверить в логах
После запуска "Обновить бюджеты" в логах должны быть:
- `Read X budget rows from sheet`
- `Processing budget row X: category=..., subcategory=..., period=..., periodValue=..., amount=...`
- `pfCalculateBudgetFact_: category=..., subcategory=..., period=..., periodValue=..., dateRange=...`
- `Read X transaction rows`
- `Transaction X matched: amount=..., total=...`
- `Calculated fact for row X: ...`
- `Writing X budget calculations to sheet`

Если видите ошибки или предупреждения - пришлите их.

### 7. Частые проблемы

#### Проблема: Категория не найдена
**Причина:** Категория в бюджете не совпадает с категориями в транзакциях
**Решение:** Используйте точное название категории из листа "Категории"

#### Проблема: Факт = 0, хотя есть транзакции
**Возможные причины:**
1. Период не совпадает (например, бюджет на 2026-01, а транзакции за 2025-12)
2. Статус транзакций не "ok"
3. Тип транзакций не "expense" или "income"
4. Категория/подкатегория не совпадают

#### Проблема: Данные не записываются в лист
**Причина:** Ошибка при записи (проверьте логи)
**Решение:** Проверьте, что лист "Бюджеты" не защищен и есть права на запись

---

## Временное решение для тестирования

Если нужно быстро протестировать:
1. Удалите бюджет с категорией "Продукты"
2. Создайте бюджет:
   - Категория: **Еда**
   - Подкатегория: (пусто) - это учтет все подкатегории "Еда"
   - Период: month
   - Значение периода: 2026-01
   - Сумма: 10000
3. Запустите "Обновить бюджеты"
4. Проверьте результат

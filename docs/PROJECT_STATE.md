# Project state (snapshot)

Дата: 2026-01-24 (обновлено)

Этот файл фиксирует текущее состояние репозитория перед началом разработки основной логики.

## Git

- Ветка: `main` (tracking: `origin/main`)
- Remote: `https://github.com/DmitryChernous/Personal_finances.git`
- Рабочая директория: см. `git status`

## Локальная привязка Google Apps Script (clasp)

- В репозитории **есть локальный** файл `.clasp.json` (он **в `.gitignore`** и не должен коммититься).
- `.clasp.json` содержит привязку к конкретному Apps Script проекту и контейнерной таблице:
  - `scriptId`: (локально)
  - `parentId` (Spreadsheet ID): (локально)
  - `rootDir`: `src`
- Шаблон для переноса/восстановления: `.clasp.json.example`

## Node / зависимости

- Node.js: `v24.13.0`
- npm: `11.6.2`
- Основная dev-зависимость: `@google/clasp@3.1.3`

## Структура проекта

- `src/appsscript.json` — манифест Apps Script (V8, Europe/Moscow)
- `src/Code.js` — меню в Google Sheets + `pfSetup()` + `onEdit()` обработчик
- `src/Setup.js` — идемпотентная инициализация (листы, шапки, валидации, именованные диапазоны, Reports, Dashboard)
- `src/Validation.js` — валидация и нормализация транзакций, подсветка ошибок
- `src/Reports.js` — генерация отчётов с формулами (доходы/расходы, категории, остатки)
- `src/Dashboard.js` — инициализация дашборда с KPI и графиками (pie chart для категорий)
- `src/TestData.js` — генерация тестовых данных для удобного тестирования (счета, категории, транзакции)
- `src/Sheets.js` — утилиты для листов + применение локализации + фильтры
- `src/I18n.js` — словари RU/EN (имена листов, заголовки, меню)
- `src/Settings.js` — хранение настроек в листе Settings/Настройки (язык, версия схемы, валюта)
- `src/Schema.js` — схемы листов (Transactions, Accounts, Categories)
- `TRANSACTIONS_SCHEMA.md` — спецификация схемы транзакций
- `README.md` — инструкции по подключению и работе через `clasp`

## Что сейчас реализовано в Apps Script

- `onOpen()` добавляет меню **Personal finances** в Google Sheets.
- Пункт меню **Setup (создать листы)** вызывает `pfSetup()`, который:
  - Устанавливает локаль таблицы `ru_RU`
  - Создаёт/обновляет листы: `Транзакции`, `Категории`, `Счета`, `Настройки`, `Инструкция`, `Отчеты`, `Дашборд`
  - Устанавливает шапки для всех таблиц (с учётом выбранного языка RU/EN)
  - Применяет автофильтры, frozen row, форматы (дата `dd.mm.yyyy`, сумма `0.00`)
  - Настраивает валидации: `Type`, `Status` (строгие списки), `Currency` (RUB/USD/EUR), `Account`/`AccountTo` (из справочника), `Category` (из справочника), `Amount > 0`
  - Создаёт именованные диапазоны `PF_ACCOUNTS` и `PF_CATEGORIES` для выпадающих списков
  - Заполняет лист `Инструкция/Help` минимальным "быстрым стартом" (если пустой)
  - Сохраняет версию схемы и валюту по умолчанию в `Settings`
- В меню есть выбор языка (RU/EN); выбранный язык сохраняется в листе настроек и применяется к именам листов и заголовкам.
- `pfSetup()` идемпотентен: повторный запуск не ломает данные и не дублирует шапки.
- **Генерация тестовых данных**: пункт меню "Заполнить тестовыми данными" создаёт реалистичные тестовые данные (5 счетов, 15 категорий, ~60 транзакций за последние 3 месяца) для удобного тестирования функционала.
- **Этап 2 завершён**: добавлена валидация и нормализация транзакций:
  - Автоматическая валидация при редактировании (`onEdit()`)
  - Проверка обязательных полей и бизнес-правил (`pfValidateTransactionRow_()`)
  - Нормализация данных (трим, автозаполнение `Source`, `Status`, `Currency`) (`pfNormalizeTransactionRow_()`)
  - Подсветка ошибок красным цветом (`pfHighlightErrors_()`)
  - Пункты меню: "Проверить все транзакции", "Пометить на проверку"

## Команды (npm scripts)

- `npm run login` — авторизация clasp
- `npm run create:sheets` — создать Google Sheet + контейнерный Apps Script, rootDir=`src`
- `npm run push` / `npm run push:force` — залить код в Apps Script
- `npm run pull` — скачать код из Apps Script
- `npm run open` — открыть контейнерный проект в браузере
- `npm run logs` — посмотреть логи

## Примечания перед разработкой основной части

- Идентификаторы `scriptId` / `parentId` **не сохраняем в git** (оставляем только локально в `.clasp.json`).
- Таблица **русскоязычная**; синтаксис формул/форматы должны быть совместимы с локалью `ru_RU` (см. `SHEETS_LOCALE.md`).
- Язык интерфейса (RU/EN) определяет имена листов/заголовки через словари в `src/I18n.js`.
- **Этап 1 (базовая часть) завершён**: `pfSetup()` создаёт полную структуру таблицы "из коробки".
- **Этап 2 (UX для транзакций) завершён и протестирован**: валидация, нормализация, подсветка ошибок, пометка на проверку. ✅ Все тесты пройдены.
- **Этап 3 (базовая аналитика) завершён и улучшен**: лист Reports с формулами для доходов/расходов, топ категорий, остатков по счетам, месячного cashflow. ✅
  - **Важно**: Топ категорий и месячный cashflow реализованы через скриптовый расчет (не QUERY формула) из-за бага Google Sheets с #N/A при программной установке QUERY.
  - **Улучшения**: Остатки по счетам теперь учитывают начальный баланс из листа Accounts и переводы (transfer).
  - **Новое**: Реализован месячный cashflow за последние 12 месяцев (доходы, расходы, итого по каждому месяцу).
- **Этап 4 (Dashboard) завершён**: лист Dashboard с KPI (доход/расход/баланс, средний расход) и графиком расходов по категориям (pie chart). ✅
  - **Важно**: Данные для графика категорий также генерируются скриптом (не QUERY) для избежания проблем с #N/A.
- **Исправлена проблема с QUERY формулами**: после множественных попыток обхода бага Google Sheets (#N/A при программной установке QUERY), принято решение использовать скриптовый расчет для топ категорий в Reports и Dashboard. Данные обновляются при вызове "Обновить отчёты" / "Обновить дашборд".
- **Доработка Этапов 3-4 завершена и протестирована**: улучшен расчет остатков по счетам, добавлен месячный cashflow, исправлены ошибки в формулах Dashboard. ✅
- **Этап 5 (Архитектура импорта) завершен**: реализован каркас импорта с DTO, staging sheet, preview/commit, дедупликация. ✅
- **Этап 6 (Реализация импортеров) завершен**: реализованы CSV и Sberbank импортеры, UI для импорта с прогресс-баром. ✅
  - **Примечание**: Дедупликация работает, но требует доработки (отложено на потом).
- **Этап 7 (Переиспользуемость/шаблон) завершен**: реализована функция `pfCreateTemplate()` для создания чистого шаблона. ✅
  - Очищает все транзакции (оставляет шапку)
  - Опция оставить/очистить демо-счета и категории
  - Очищает Import_Raw, обновляет Reports/Dashboard
  - Обновляет Settings с датой создания шаблона
- **Этап 8 (Инструкция в Help) завершен**: расширен лист Help с подробными инструкциями. ✅
  - Быстрый старт (5 шагов)
  - Правила и особенности (Amount, типы транзакций, дедупликация)
  - FAQ (импорт, обновление, отчеты, шаблоны, права доступа)
  - Troubleshooting (ошибки валидации, проблемы с импортом, ошибки формул)
  - Поддержка RU и EN языков
  - Автоматическое обновление содержимого при Setup
- **Все основные этапы реализации завершены!** ✅

## Новые этапы разработки (2026-01-25)

### Stage 1: Budgeting (TASK-001) ✅
**Статус:** Завершено и протестировано  
**Дата завершения:** 25 января 2026

**Реализовано:**
- ✅ Схема бюджетов (`PF_BUDGETS_SCHEMA`) с полями: Category, Subcategory, Period, PeriodValue, Amount, Fact, Remaining, Status, PercentUsed, Active, Description
- ✅ Модуль `src/Budgets.js` с функциями:
  - `pfInitializeBudgets_()` - инициализация листа с валидацией и форматированием
  - `pfCalculateBudgetFact_()` - расчет фактических расходов из транзакций
  - `pfGetBudgetStatus_()` - определение статуса (OK, WARNING, EXCEEDED)
  - `pfUpdateBudgetCalculations_()` - обновление всех расчетных полей
  - `pfUpdateBudgetCalculations()` - публичная функция для меню
- ✅ Интеграция в Setup, Reports, Dashboard
- ✅ Меню "Обновить бюджеты"
- ✅ Поддержка месячных и годовых бюджетов
- ✅ Условное форматирование (красный для превышенных, желтый для предупреждений)
- ✅ Обработка Date объектов в поле PeriodValue (Google Sheets автоматически преобразует "2026-01" в дату)

**Исправленные проблемы:**
- Исправлена логика проверки "Активно" (пустое значение = активен по умолчанию)
- Добавлена обработка Date объектов в PeriodValue (преобразование в формат YYYY-MM)
- Добавлено детальное логирование для отладки

**Тестирование:**
- ✅ Проверена работа с тестовыми данными
- ✅ Проверен расчет факта для категорий с подкатегориями и без
- ✅ Проверена работа статусов (OK, WARNING, EXCEEDED)
- ✅ Проверена интеграция в Reports и Dashboard

### Stage 2: Recurring Transactions (TASK-002) ✅
**Статус:** Завершено  
**Дата завершения:** 25 января 2026

**Реализовано:**
- ✅ Схема регулярных платежей (`PF_RECURRING_TRANSACTIONS_SCHEMA`)
- ✅ Модуль `src/RecurringTransactions.js` с функциями:
  - `pfInitializeRecurringTransactions_()` - инициализация листа
  - `pfShouldCreateTransaction_()` - проверка необходимости создания транзакции
  - `pfGetNextDueDate_()` - расчет следующей даты платежа
  - `pfCreateRecurringTransactions_()` - создание транзакций
  - `pfCreateRecurringTransactions()` - публичная функция для меню
- ✅ Поддержка частот: weekly, monthly, quarterly, yearly
- ✅ Интеграция в Setup и Sheets
- ✅ Меню "Создать регулярные платежи"
- ✅ Защита от дубликатов (проверка по LastCreated)

**Примечание:** Функционал реализован, но пользователь отметил, что регулярные платежи и так будут в банковской выписке, поэтому не видит большого смысла в отдельном учете. Функционал оставлен для возможного использования в будущем.

### Stage 3: Auto-categorization (TASK-003) ✅
**Статус:** Завершено  
**Дата завершения:** 25 января 2026

**Реализовано:**
- ✅ Схема правил категоризации (`PF_CATEGORY_RULES_SCHEMA`) с полями: RuleName, Pattern, PatternType, Category, Subcategory, Priority, Active, ApplyTo
- ✅ Константы `PF_PATTERN_TYPE` (contains, startsWith, endsWith, regex, exact) и `PF_RULE_APPLY_TO` (merchant, description, both)
- ✅ Модуль `src/CategoryRules.js` с функциями:
  - `pfInitializeCategoryRules_()` - инициализация листа с валидацией
  - `pfGetAllCategoryRules_()` - загрузка всех активных правил из листа
  - `pfMatchCategoryRule_()` - поиск подходящего правила для транзакции
  - `pfMatchPattern_()` - проверка соответствия паттерну
  - `pfApplyCategoryRules_()` - применение правил к транзакции
  - `pfApplyAutoCategorizationToAll_()` - применение ко всем транзакциям без категории
  - `pfApplyAutoCategorizationToAll()` - публичная функция для меню
  - `pfCreateDefaultCategoryRules_()` - предзаполнение правил по умолчанию
- ✅ Интеграция автокатегоризации в `Import.js` (pfProcessDataBatch) - автоматическое применение при импорте
- ✅ Интеграция в Setup.js и Sheets.js
- ✅ Меню "Применить автокатегоризацию"
- ✅ Поддержка типов паттернов: contains, startsWith, endsWith, regex, exact
- ✅ Поддержка применения к полям: merchant, description, both
- ✅ Приоритет правил (правила с большим приоритетом применяются первыми)
- ✅ Предзаполненные правила для популярных российских магазинов, ресторанов, транспорта и т.д.

**Особенности:**
- Автокатегоризация применяется автоматически при импорте транзакций (если категория не установлена)
- Правила не перезаписывают существующие категории
- Поддержка case-insensitive поиска (кроме regex)
- Обработка ошибок при невалидных regex паттернах
- Fallback логика: если правило настроено на одно поле и не сработало, проверяются оба поля

### Stage 5: Advanced Analytics (TASK-005) ✅
**Статус:** Завершено  
**Дата завершения:** 25 января 2026

**Реализовано:**
- ✅ Сравнение с предыдущим периодом в Reports:
  - Колонка "Предыдущий месяц" (Net предыдущего месяца)
  - Колонка "Изменение" (разница между текущим и предыдущим месяцем)
  - Колонка "Изменение %" (процент изменения)
  - Условное форматирование (зеленый для улучшения, красный для ухудшения)
- ✅ Секция "Средние значения" в Reports:
  - Средний расход в день (текущий месяц)
  - Средний расход в месяц (за последние 3/6/12 месяцев)
  - Средний доход в месяц (за последние 3/6/12 месяцев)
- ✅ Секция "Прогноз" в Reports:
  - Прогноз расходов на следующий месяц (среднее за последние 3 месяца)
  - Прогноз доходов на следующий месяц (среднее за последние 3 месяца)
  - Прогноз итого (Net) на следующий месяц
- ✅ Line chart в Dashboard:
  - График динамики доходов и расходов по месяцам (последние 12 месяцев)
  - Использование Google Sheets Charts API
  - Размер графика: 600x400 пикселей
  - Легенда и подписи осей

**Особенности:**
- Все расчеты используют скриптовый подход для консистентности
- Условное форматирование для визуального отображения изменений
- Прогноз основан на простом среднем за последние 3 месяца (можно расширить до линейной регрессии)

## Архитектурные улучшения (2026-01-25)

Проведен полный архитектурный ревью и исправлены все выявленные проблемы (критические, средние и низкоприоритетные):

### Исправленные проблемы:

1. **#5 - Дублирование логики дедупликации** ✅
   - Создана единая функция `pfGenerateDedupeKey_()` для TransactionDTO и sheet rows
   - Устранено дублирование в 3 местах
   - Исправлен баг с рассинхронизацией логики

2. **#8 - Магические значения** ✅
   - Создан `Constants.js` с константами для статусов, типов, источников, размеров
   - Все магические строки/числа заменены на константы
   - Улучшена поддерживаемость

3. **#6 - Централизованная обработка ошибок** ✅
   - Создан `ErrorHandler.js` с единой системой логирования
   - Уровни: DEBUG, INFO, WARNING, ERROR (текущий: WARNING)
   - Единый формат ответов (`pfCreateErrorResponse_`, `pfCreateSuccessResponse_`)

4. **#4 - Избыточное логирование** ✅
   - Удалены DEBUG логи (оставлены только ERROR/WARNING)
   - Сокращено количество логов в `Import.js` с 120+ до ~43 (только критичные)
   - Улучшена производительность

5. **#10 - Дублирование очистки sheet** ✅
   - Создана функция `pfClearSheetRows_()` в `Sheets.js`
   - Заменены 7 дублирующихся мест на единую функцию

6. **#15 - Валидация входных данных** ✅
   - Добавлена валидация во все публичные функции
   - Проверка типов, диапазонов, форматов
   - Использование ErrorHandler для единообразных ошибок

7. **#1, #2 - Мертвый код** ✅
   - `pfProcessFileImport_()` и `pfProcessImportData_()` помечены как deprecated
   - Функции заменены на простые `throw new Error()` с объяснением

8. **#3 - Хардкод в меню** ✅
   - Добавлена i18n поддержка для "Найти дубликат"
   - Все пункты меню используют систему i18n

9. **#21 - Персональные данные** ✅
   - Файлы удалены из файловой системы
   - Уже в `.gitignore`

### Тестирование:

- Создан модуль `Tests.js` с unit-тестами для критичных функций:
  - Тесты констант ✅
  - Тесты ErrorHandler ✅
  - Тесты дедупликации (консистентность ключей) ✅
  - Тесты очистки sheet (edge cases) ✅
  - Тесты валидации входных данных ✅
- Добавлен пункт меню "Запустить тесты" для удобного запуска
    - Тесты можно запускать из Apps Script редактора или через меню
    - **Все тесты проходят успешно (5/5)** ✅

9. **#22 - Очистка package.json** ✅
   - Удалены неиспользуемые поля `main` и `type`
   - Улучшена чистота конфигурации

10. **#12 - Утилиты для конвертации Date** ✅
    - Создан модуль `DateUtils.js` с функциями:
      - `pfDateToISOString_()` - конвертация Date в ISO строку
      - `pfISOStringToDate_()` - конвертация ISO строки в Date
      - `pfFormatDateForDedupe_()` - форматирование для дедупликации
    - Заменена вся логика конвертации дат в Import.js

11. **#11 - Демо-данные в отдельный модуль** ✅
    - Создан модуль `DemoData.js` с централизованными демо-данными
    - Функции `pfResetDemoAccounts_`, `pfCreateDemoAccounts_`, `pfResetDemoCategories_`, `pfCreateDemoCategories_` вынесены из Template.js
    - Устранено дублирование между Template.js и TestData.js

12. **#19, #20 - Организация документации** ✅
    - Создана папка `docs/` для всей документации
    - Все .md файлы (кроме README.md) перемещены в docs/
    - Устаревшие документы помечены как устаревшие
    - Улучшена структура проекта

13. **#13, #14 - Оптимизация производительности** ✅
    - Кэширование `getLastRow()` во всех модулях:
      - Reports.js: кэширование перед циклом (было 12 вызовов)
      - Dashboard.js: кэширование перед обработкой данных
      - Import.js: кэширование stagingLastRow в pfCommitImport_
      - TestData.js: кэширование во всех функциях генерации
    - Значительное улучшение производительности при работе с большими таблицами

14. **#16, #17, #18 - Надежность и безопасность** ✅
    - Добавлена обработка edge cases:
      - Проверки на пустые sheets, null доступ к таблице
      - Валидация массивов, обработка отсутствующих sheets
    - Добавлена валидация количества строк в pfParseFileContent
    - Добавлена санитизация входных данных в pfFindDuplicateByKey
    - Улучшена надежность всех публичных функций

15. **#7 - Рефакторинг модулей** ✅ (частично)
    - Создан модуль `Help.js` с функциями Help content
    - Функции `pfEnsureHelpContent_`, `_writeHelpContentRu_`, `_writeHelpContentEn_` вынесены из Setup.js
    - Setup.js теперь фокусируется только на логике setup
    - Примечание: Разбиение Import.js на подмодули отложено (большая задача, требует тщательного планирования)


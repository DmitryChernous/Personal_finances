# Схема листа `Transactions` (финальная спецификация)

Дата: 2026-01-24

Цель: единый “канонический” формат транзакций для ручного ввода и будущего импорта выписок.

## Базовые правила

- **Локаль таблицы**: `ru_RU` (подробности: `SHEETS_LOCALE.md`)
- **Язык интерфейса** (имена листов/заголовки) выбирается в таблице и может быть `ru` или `en` (см. `src/I18n.js`).
- **Сумма** хранится как **положительное число** в колонке `Amount`, а направление задаётся колонкой `Type`.
- **Перевод между счетами** — это `Type = transfer` и обязательные `Account` + `AccountTo`.  
  Такие строки не должны попадать в “расходы по категориям”.

## Колонки (порядок и назначение)

| # | Заголовок (RU) | Key (в коде) | Тип | Обяз. | Примечание |
|---:|---|---|---|:---:|---|
| 1 | Дата | `Date` | дата/время | ✅ | дата операции (достаточно даты, время опционально) |
| 2 | Тип | `Type` | enum | ✅ | `expense` / `income` / `transfer` |
| 3 | Счет | `Account` | string | ✅ | счёт-источник/основной |
| 4 | Счет (получатель) | `AccountTo` | string | ➖ | обязателен **только** для `transfer` |
| 5 | Сумма | `Amount` | number | ✅ | положительное число |
| 6 | Валюта | `Currency` | enum | ✅ | валюта (по умолчанию из `Settings`) |
| 7 | Категория | `Category` | string | ➖ | обязателен для `expense/income`, пусто для `transfer` |
| 8 | Подкатегория | `Subcategory` | string | ➖ | опционально |
| 9 | Место/контрагент | `Merchant` | string | ➖ | магазин/контрагент |
| 10 | Комментарий | `Description` | string | ➖ | комментарий/назначение |
| 11 | Теги | `Tags` | string | ➖ | теги через запятую (позже можно стандартизировать) |
| 12 | Источник | `Source` | string | ✅ | `manual` или `import:<bank>` / `import:csv` |
| 13 | ID источника | `SourceId` | string | ➖ | id операции из выписки (для дедупликации) |
| 14 | Статус | `Status` | enum | ✅ | `ok` / `needs_review` / `duplicate` / `deleted` |

## Валидации (что планируем включить на Этапе 1.2)

- `Type`: список значений `expense,income,transfer`
- `Currency`: список валют из `Settings` (или фиксированный список на старте)
- `Account`/`AccountTo`: выбор из справочника `Accounts`
- `Category`/`Subcategory`: выбор из справочника `Categories`
- `Amount`: число \(> 0\)

## Ключ дедупликации

Ключ дедупликации формируется единой функцией `pfCanonicalDedupeKey_` (в `src/Import.js`). Raw-листы и импорт должны использовать её для согласованности. Формат: `source + ':' + (sourceId || hash)`; при отсутствии SourceId используется хэш полей (дата, счёт, сумма, тип). См. также `docs/RAW_SHEETS_ARCHITECTURE.md`.

## Поля, которые можно добавить позже (не в Этапе 1)

- `Id` (внутренний UUID строки)
- `Fingerprint` (хэш для дедупликации)
- `CreatedAt`, `UpdatedAt` (аудит)


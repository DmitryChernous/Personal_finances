# Статус реализации импорта PDF

**Дата последнего обновления:** 2026-01-25  
**Статус:** Частично реализовано, требуется доработка парсинга

---

## Что реализовано ✅

### Этап 1: Базовая инфраструктура PDF импорта ✅ ЗАВЕРШЕНО

- ✅ Создан модуль `src/ImportPdf.js` с базовым импортером
- ✅ Реализовано извлечение текста из PDF через Google Drive API с OCR
- ✅ Добавлена поддержка PDF в UI (`ImportUI.html`)
- ✅ Обновлен `pfDetectFileFormat` для распознавания PDF
- ✅ Добавлены необходимые OAuth scopes в `appsscript.json`
- ✅ Включен Advanced Drive API

### Этап 2: Парсер для Сбербанка PDF ✅ ЧАСТИЧНО ЗАВЕРШЕНО

- ✅ Создан модуль `src/ImportPdfSberbank.js`
- ✅ Реализован парсинг текста выписки Сбербанка
- ✅ Обработка многостраничных PDF (все секции транзакций)
- ✅ Определение типа транзакции (income/expense):
  - ✅ По наличию "+" в категории (например, "Прочие операции +50")
  - ✅ По наличию "Заработная плата" в описании
- ✅ Базовое извлечение merchant из описания
- ✅ Генерация sourceId для дедупликации

### Оптимизация производительности ✅ ЗАВЕРШЕНО

- ✅ Уменьшен размер батча для PDF (50 вместо 200)
- ✅ Отключена автоматическая категоризация для PDF (из-за медленной работы `pfGetAllCategoryRules_`)
- ✅ Оптимизирована загрузка ключей дедупликации (chunked processing для больших листов)
- ✅ Добавлено подробное логирование для отладки

---

## Известные проблемы и что нужно доработать ⚠️

### 1. Извлечение merchant (Место/контрагент) ⚠️ ТРЕБУЕТ ДОРАБОТКИ

**Проблема:**
- Часто попадает "****7426" вместо реального названия магазина/контрагента
- Иногда попадает "по карте ****7426", "карте", "Операция" вместо названия
- Для транзакций типа "Перевод СБП" merchant должен быть "Перевод для Ч. Дмитрий Вячеславович", а не "по карте ****7426"

**Примеры из результатов импорта:**
- Строка 2: merchant = "по карте ****7426" (должно быть "Перевод для Ч. Дмитрий Вячеславович")
- Строка 3: merchant = "****7426" (должно быть "YUG-FARM Shakhty")
- Строка 31: merchant = "карте" (должно быть реальное название)

**Что нужно:**
- Улучшить логику извлечения merchant из многострочных описаний
- Правильно обрабатывать случаи, когда описание начинается с даты
- Извлекать название до "RUS" или "Операция", но не включать "по карте" и номер карты
- Для переводов СБП извлекать имя получателя из описания

**Где исправлять:**
- `src/ImportPdfSberbank.js` - функция `normalize()`, секция извлечения merchant (строки ~345-377)

---

### 2. Описание транзакций ⚠️ ТРЕБУЕТ ДОРАБОТКИ

**Проблема:**
- Для некоторых транзакций (особенно с зарплатой) в поле "Комментарий" попадает полная строка транзакции вместо нормального описания
- Например: "15.12.2025 11:19 881767 Прочие операции +350,00 42 087,04 15.12.2025 Заработная плата"

**Примеры из результатов импорта:**
- Строка 48: description содержит полную строку транзакции
- Строка 104: аналогично
- Строка 163: аналогично

**Что нужно:**
- Улучшить сбор описания из многострочных данных
- Не включать полные строки транзакций в описание
- Для транзакций с зарплатой оставлять только "Заработная плата" или имя отправителя

**Где исправлять:**
- `src/ImportPdfSberbank.js` - функция `parse()`, логика сбора description (строки ~192-250)
- `src/ImportPdfSberbank.js` - функция `normalize()`, обработка description (строки ~322-343)

---

### 3. SourceId для некоторых транзакций ⚠️ ТРЕБУЕТ ДОРАБОТКИ

**Проблема:**
- Для некоторых транзакций (особенно с зарплатой) sourceId генерируется неполный
- Например: "15122025350" вместо полного "151220251119881767"
- Это может привести к проблемам с дедупликацией

**Примеры из результатов импорта:**
- Строка 48: sourceId = "15122025350" (неполный)
- Строка 104: sourceId = "14112025350" (неполный)
- Строка 163: sourceId = "15102025350" (неполный)

**Что нужно:**
- Убедиться, что для всех транзакций правильно извлекаются date, time и authCode
- Улучшить обработку транзакций с зарплатой, чтобы не терялись данные
- Проверить, что парсер правильно обрабатывает многострочные транзакции

**Где исправлять:**
- `src/ImportPdfSberbank.js` - функция `parse()`, обработка строк продолжения (строки ~192-250)
- `src/ImportPdfSberbank.js` - функция `normalize()`, генерация sourceId (строки ~379-410)

---

### 4. Транзакции с суммой 0 ⚠️ ТРЕБУЕТ ПРОВЕРКИ

**Проблема:**
- Некоторые транзакции имеют сумму 0, что вызывает ошибки валидации
- Статус: "needs_review" с ошибкой "Amount: Сумма должна быть положительным числом"

**Примеры из результатов импорта:**
- Строка 318: amount = 0, income
- Строка 322: amount = 0, income
- Строка 332: amount = 0, income
- И еще несколько

**Что нужно:**
- Проверить, откуда берутся эти транзакции с суммой 0
- Возможно, это ошибка парсинга или это реальные транзакции (корректировки, отмены)
- Если это ошибка парсинга - исправить
- Если это реальные транзакции - обработать их особым образом или пропускать

**Где проверять:**
- `src/ImportPdfSberbank.js` - функция `parse()`, парсинг суммы (строки ~164-165)
- `src/ImportPdfSberbank.js` - функция `_parseAmount_()`, конвертация формата (строки ~276-286)

---

## Структура PDF выписки Сбербанка

### Формат транзакции:

```
31.12.2025 16:40 966521 Перевод СБП 1 500,00 96 776,18
31.12.2025 Перевод для Ч. Дмитрий Вячеславович. Операция
по карте ****7426
```

Где:
- Строка 1: `дата время код_авторизации категория сумма остаток`
- Строка 2+: Описание операции (может быть многострочным)
- Последняя строка: "по карте ****7426" или "Операция по карте ****7426"

### Формат транзакции с зарплатой:

```
26.12.2025 13:05 062896 Прочие операции +50 809,00 116 056,45
26.12.2025 Заработная плата. Операция по карте ****7426
```

Где:
- Категория содержит "+" (например, "+50", "+350")
- Описание содержит "Заработная плата"
- Это income транзакция

---

## Тестовые данные

**Файлы для тестирования:**
- `Сбер Карта.pdf` - реальная выписка Сбербанка (в .gitignore)
- `Сбер Карта.csv` - CSV версия для сравнения (в .gitignore)

**Результаты импорта для анализа:**
- `Personal finances - Импорт (черновик).csv` - первый результат
- `Personal finances - Импорт (черновик) (1).csv` - последний результат

---

## Следующие шаги

1. **Улучшить извлечение merchant:**
   - Анализировать структуру описания более тщательно
   - Правильно обрабатывать многострочные описания
   - Извлекать реальное название магазина/контрагента

2. **Исправить обработку описаний:**
   - Не включать полные строки транзакций
   - Правильно собирать многострочные описания
   - Очищать от служебной информации

3. **Исправить генерацию sourceId:**
   - Убедиться, что все поля (date, time, authCode) правильно извлекаются
   - Особое внимание к транзакциям с зарплатой

4. **Разобраться с транзакциями с суммой 0:**
   - Проверить, откуда они берутся
   - Решить, как их обрабатывать

---

## Технические детали

### Текущие настройки:
- Размер батча для PDF: 50 транзакций
- Размер батча для CSV/Sberbank: 200 транзакций
- Автоматическая категоризация: отключена для PDF

### Логирование:
- Добавлено подробное логирование в `pfGetExistingTransactionKeys_()`
- Добавлено логирование в `pfProcessDataBatch()` для отслеживания производительности
- Префиксы: `[KEYS]`, `[SERVER]`, `[CLIENT]`

---

## Примечания

- Парсинг работает, но качество данных требует улучшения
- Основные проблемы связаны с извлечением merchant и обработкой многострочных описаний
- Для продолжения работы использовать этот файл как отправную точку

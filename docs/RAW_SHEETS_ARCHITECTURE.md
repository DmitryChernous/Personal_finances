# Архитектура: raw-листы → обработка → анализ

Цель: собирать данные с листов, название которых начинается на `raw` (по одному листу на счёт), обрабатывать их в единый формат и использовать для анализа. Новые данные на raw-листах должны подхватываться без ручного копирования.

---

## 1. Текущее состояние

- **Транзакции** — один лист, основной источник для Дашборда, Отчётов, Бюджетов (формулы SUMIFS, QUERY по имени листа «Транзакции»).
- **Импорт** — файлы CSV/PDF через UI пишутся в лист «Импорт (черновик)», затем коммит добавляет строки в «Транзакции».
- Справочники: Счета, Категории, Правила категоризации и т.д.

Raw-листы пользователя сейчас **вне** этой схемы: это отдельные листы с префиксом `raw`, по одному на счёт, данные только с этого счёта.

---

## 2. Целевая архитектура (слои)

```
┌─────────────────────────────────────────────────────────────────┐
│  ИСТОЧНИКИ ДАННЫХ                                                │
├─────────────────────────────────────────────────────────────────┤
│  raw* листы           │  Ручной ввод / импорт через UI           │
│  (один лист = счёт)   │  (как сейчас → Транзакции)               │
└───────────┬───────────┴──────────────────┬──────────────────────┘
            │                              │
            ▼                              │
┌───────────────────────┐                  │
│  Синхронизация        │                  │
│  (скрипт по меню      │                  │
│   или триггер)        │                  │
│  • обход листов raw*  │                  │
│  • нормализация       │                  │
│  • дедупликация       │                  │
│  • добавление только  │                  │
│    новых строк        │                  │
└───────────┬───────────┘                  │
            │                              │
            ▼                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  ЕДИНЫЙ СЛОЙ: лист «Транзакции»                                  │
│  Все операции: с raw + вручную + из импорта. Один формат колонок.│
└───────────┬─────────────────────────────────────────────────────┘
            │
            ▼
┌─────────────────────────────────────────────────────────────────┐
│  АНАЛИЗ (без изменений)                                          │
│  Дашборд, Отчёты, Бюджеты — читают только «Транзакции».          │
└─────────────────────────────────────────────────────────────────┘
```

Идея: raw-листы и импорт/ручной ввод **все пишут в один и тот же лист «Транзакции»**. Сырые данные живут на raw*, а «на лету» подхватываются через **запуск синхронизации** (меню или триггер).

---

## 3. Конвенция raw-листов

### 3.1. Имена листов

- Имя листа **начинается с** `raw` (регистр не важен для поиска в коде).
- Рекомендуемый формат: `raw_<Счёт>`, например: `raw_Сбербанк`, `raw_Яндекс Карта`, `raw_Tinkoff`.
- По имени листа определяется **счёт (Account)** для всех строк этого листа (например, подстрока после `raw_` или после `raw`).

### 3.2. Фактический формат raw-листов (по примерам raw_sber_card, raw_yandex_card)

- **Первая строка** — заголовки (табуляция или иной разделитель в одной ячейке не используются; каждая колонка — отдельная ячейка).
- **Колонки по порядку** (A, B, C, …):

| Колонка | Заголовок raw      | Маппинг в канон | Примечание |
|---------|--------------------|-----------------|------------|
| A       | ДАТА               | Date            | dd.mm.yyyy |
| B       | ВРЕМЯ              | —               | используется только для SourceId (дедупликация) |
| C       | КАТЕГОРИЯ          | Category        | как есть   |
| D       | ОПИСАНИЕ            | Description     | как есть   |
| E       | СУММА              | Amount + Type   | число: минус = расход, плюс = доход; в каноне Amount > 0, Type = expense/income |
| F       | ОСТАТОК СРЕДСТВ    | —               | не переносится |
| G       | СЧЕТ               | Account         | если пусто — подставляется из имени листа |

- **Тип (Type)** вычисляется по знаку СУММЫ: отрицательная → `expense`, положительная → `income`.
- **Source** = `raw:` + имя листа (например, `raw:raw_sber_card`).
- **SourceId** = уникальный идентификатор строки для дедупликации (например, дата+время+сумма без пробелов/запятых).
- **Currency** по умолчанию RUB; **Status** по умолчанию `ok`; **AccountTo**, **Subcategory**, **Merchant**, **Tags** — пустые, если в raw нет соответствующих колонок.

### 3.3. Вариант с другим форматом raw (Raw_Config)

Лист **«Raw_Config»** задаёт маппинг колонок для raw-листов с нестандартным порядком или заголовками.

**Формат листа Raw_Config:**

| Колонка A       | Колонка B          | Колонка C            |
|-----------------|--------------------|------------------------|
| SheetName       | RawColumnIndex     | CanonicalField         |
| raw_ДругойБанк  | 1                  | Amount                 |
| raw_ДругойБанк  | 2                  | Date                   |
| raw_ДругойБанк  | 3                  | Time                   |
| raw_ДругойБанк  | 4                  | Category               |
| raw_ДругойБанк  | 5                  | Description            |
| raw_ДругойБанк  | 6                  | Account                |

- **SheetName** — точное имя raw-листа (например, `raw_ДругойБанк`).
- **RawColumnIndex** — номер колонки на raw-листе (1 = A, 2 = B, …).
- **CanonicalField** — поле канонической схемы: `Date`, `Time`, `Category`, `Description`, `Amount`, `Balance`, `Account`. Обязательны для чтения: `Date` и `Amount`; остальные опциональны.

Для одного листа задаётся несколько строк (по одной на каждое сопоставляемое поле). Если для имени листа в Raw_Config нет ни одной строки, используется фиксированная схема из п. 3.2 (A=ДАТА, B=ВРЕМЯ, …). Подробнее — в разделе справки «Другой формат выписки».

---

## 4. Синхронизация raw → Транзакции

### 4.1. Алгоритм (один запуск)

1. Найти все листы, имя которых начинается с `raw` (без учёта регистра).
2. Для каждого такого листа:
   - прочитать строки со 2-й по последнюю (1-я — заголовки);
   - для каждой строки: собрать объект в формате канонической транзакции (при необходимости подставить Account из имени листа, Source = `raw` или `raw:ИмяЛиста`);
   - для каждой такой транзакции проверить, есть ли она уже в «Транзакции» (дедупликация по Source + SourceId, или по Date + Account + Amount + описание, если SourceId нет).
3. Все **новые** строки (ещё не представленные в «Транзакции») записать в конец листа «Транзакции» (append). Статус по умолчанию — например, `ok` или `needs_review`.

Итог: лист «Транзакции» остаётся единственным местом, откуда читают Дашборд/Отчёты/Бюджеты; они «на лету» видят и старые, и новые данные после очередного запуска синхронизации.

### 4.2. Когда запускать («на лету»)

- **По меню**: пункт «Синхронизировать с raw-листами» (или аналог) — пользователь сам решает, когда подтянуть новые строки с raw.
- **По триггеру**: раз в день (или раз в N часов) — время-driven trigger вызывает ту же функцию синхронизации.
- **При открытии таблицы**: по желанию можно вызывать синхронизацию в `onOpen` (тогда лучше делать её быстрой или с кэшем «последний запуск не более 5 минут назад», чтобы не тормозить открытие).

Рекомендация на старте: **только меню**; триггер и onOpen добавить при необходимости.

### 4.3. Дедупликация

- Если на raw-листе есть **SourceId** — считать ключом пару `(Source, SourceId)` (как в текущей логике импорта).
- Если SourceId нет — ключ: `(Date, Account, Amount, Description)` или `(Date, Account, Amount)` и считать дубликатом совпадение по этому ключу в «Транзакции» с тем же Source (например, `raw:raw_Сбербанк`).

Так мы не будем дублировать строки при повторных запусках синхронизации.

---

## 5. Обработка данных для анализа

- **Нормализация** выполняется уже при синхронизации: приведение даты, типа, суммы, подстановка счёта из имени raw-листа, единые значения Source/Status.
- **Категоризация**: после добавления строк в «Транзакции» можно один раз вызвать существующую функцию **«Применить автокатегоризацию»** (правила из «Правила категоризации»), чтобы заполнить Category/Subcategory по описанию/контрагенту.
- **Анализ** не меняется: Дашборд, Отчёты, Бюджеты продолжают ссылаться на лист «Транзакции» (те же формулы). Новые данные появляются там после синхронизации и сразу учитываются в отчётах и дашборде.

---

## 6. Что не меняем

- Лист **«Транзакции»** — по-прежнему единственный источник для анализа; его схема и расположение колонок не меняются.
- **Импорт через UI** (CSV/PDF) — как сейчас пишет в «Импорт (черновик)» и по коммиту — в «Транзакции». Можно оставить источником `import:csv` / `import:pdf` и т.д.
- **Ручной ввод** и быстрый ввод — по-прежнему в «Транзакции».
- Справочники **Счета**, **Категории**, **Правила категоризации** — без изменений. При синхронизации нужно лишь проверять, что подставленный Account есть в справочнике Счетов (или добавлять его туда при первом появлении — опционально).

---

## 7. План реализации (кратко)

| Шаг | Действие |
|-----|-----------|
| 1 | Ввести константу/паттерн имён raw-листов (например, имя начинается с `raw`) и функцию получения списка таких листов. |
| 2 | Реализовать функцию чтения одного raw-листа в массив объектов (по текущей схеме колонок Транзакций; при пустом Account — подставлять из имени листа). |
| 3 | Реализовать дедупликацию: по (Source, SourceId) или по (Date, Account, Amount [, Description]) в пределах источника `raw:...`. |
| 4 | Реализовать основную функцию синхронизации: обход raw-листов → чтение → дедупликация против «Транзакции» → append новых строк. |
| 5 | Добавить пункт меню «Синхронизировать с raw-листами» и вызов этой функции. |
| 6 | (Опционально) Настройка триггера раз в день; (опционально) лист Raw_Config и маппинг колонок для нестандартных raw-листов. |

После этого данные с raw-листов будут собираться в «Транзакции», обрабатываться (нормализация + при желании автокатегоризация) и анализироваться текущими отчётами и дашбордом без смены архитектуры анализа.
